<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Powder XRD Simulator (v3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: #f0f0f0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #app-container { display: flex; width: 100%; flex-grow: 1; min-height: 0; }
        #controls-panel { width: 420px; min-width: 320px; max-width: 600px; flex-shrink: 0; padding: 24px; background-color: #111827; border-right: 1px solid #374151; overflow-y: auto; color: #d1d5db; }
        #drag-handle { width: 6px; cursor: col-resize; background-color: #374151; flex-shrink: 0; transition: background-color 0.2s; }
        #drag-handle:hover { background-color: #3b82f6; }
        #results-area { flex-grow: 1; position: relative; background-color: #ffffff; min-width: 0; display: flex; flex-direction: column; padding: 1.5rem; color: #1f2937; }
        .control-group { margin-bottom: 1.5rem; }
        .control-label { display: block; margin-bottom: 8px; font-weight: 500; color: #9ca3af; }
        .control-input, .control-select { width: 100%; background-color: #374151; border: 1px solid #4b5563; color: #e5e7eb; border-radius: 0.375rem; padding: 0.75rem; transition: all 0.2s ease; }
        .control-input:focus, .control-select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        footer { width: 100%; background-color: #ffffff; padding: 8px 24px; font-size: 0.8em; color: #4b5563; border-top: 1px solid #e5e7eb; flex-shrink: 0; }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #4b5563; border-radius: 5px; outline: none; transition: background 0.2s; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #e5e7eb; border-radius: 50%; cursor: pointer; border: 2px solid #374151;}
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: #e5e7eb; border-radius: 50%; cursor: pointer; border: 2px solid #374151; }
    </style>
</head>
<body>

    <div id="app-container">
        <div id="controls-panel">
            <h1 class="text-2xl font-bold text-white mb-2">Powder XRD Simulator</h1>
            <p class="text-sm text-gray-400 mb-6">Visualize diffraction patterns for cubic crystal structures.</p>
            
            <div class="space-y-6">
                <div class="control-group">
                    <label for="crystal-structure" class="control-label">Crystal Structure</label>
                    <select id="crystal-structure" class="control-select">
                        <option value="SC" selected>Simple Cubic (SC)</option>
                        <option value="FCC">Face-Centered Cubic (FCC)</option>
                        <option value="BCC">Body-Centered Cubic (BCC)</option>
                        <option value="Diamond">Diamond Cubic</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="lattice-parameter" class="control-label">Lattice Parameter (a) in Å: <span id="lattice-parameter-value" class="font-semibold text-white">5.43</span></label>
                    <input type="range" id="lattice-parameter" min="2.0" max="10.0" value="5.43" step="0.01">
                </div>
                <div class="control-group">
                    <label for="xray-wavelength" class="control-label">X-Ray Wavelength (λ) in Å</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="xray-wavelength" value="1.5406" step="0.0001" class="control-input">
                        <select id="wavelength-preset" class="control-select w-auto pr-8">
                            <option value="1.5406">Cu Kα</option>
                            <option value="0.7093">Mo Kα</option>
                            <option value="1.7889">Co Kα</option>
                        </select>
                    </div>
                </div>
                 <div class="control-group">
                    <label for="thermal-factor" class="control-label">Thermal Factor B (Å²): <span id="thermal-factor-value" class="font-semibold text-white">0.5</span></label>
                    <input type="range" id="thermal-factor" min="0" max="3" value="0.5" step="0.1">
                </div>
                <div class="control-group">
                    <label for="polarization-factor" class="control-label">Polarization</label>
                    <select id="polarization-factor" class="control-select">
                        <option value="unpolarized" selected>Unpolarized</option>
                        <option value="linear_horizontal">Linear Horizontal</option>
                        <option value="linear_vertical">Linear Vertical</option>
                    </select>
                </div>
                 <hr class="border-gray-600">
                <div class="control-group">
                    <label for="two-theta-min" class="control-label">Graph 2θ Min (°): <span id="two-theta-min-value" class="font-semibold text-white">10</span></label>
                    <input type="range" id="two-theta-min" min="5" max="160" value="10" step="1">
                </div>
                <div class="control-group">
                    <label for="two-theta-max" class="control-label">Graph 2θ Max (°): <span id="two-theta-max-value" class="font-semibold text-white">100</span></label>
                    <input type="range" id="two-theta-max" min="5" max="160" value="100" step="1">
                </div>
            </div>
        </div>

        <div id="drag-handle"></div>

        <div id="results-area">
            <div id="results-container" class="w-full h-full flex flex-col">
                <h2 class="text-2xl font-semibold mb-4 text-center text-gray-800">Diffraction Pattern</h2>
                <div class="relative flex-1 min-h-0">
                    <canvas id="xrd-chart"></canvas>
                </div>
                <h3 class="text-xl font-semibold mt-6 mb-4 border-t pt-4 text-gray-800">Calculated Diffraction Peaks</h3>
                <div class="relative flex-1 overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">2θ (°)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">d-spacing (Å)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">(hkl)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Multiplicity</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Intensity</th>
                            </tr>
                        </thead>
                        <tbody id="peak-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <footer id="footer-date">
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Set Date in Footer ---
        const footer = document.getElementById('footer-date');
        const now = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        footer.textContent = `NitaD, Univ Paris-Saclay, ${now.toLocaleDateString('en-US', options)}`;
        
        // --- DOM Element References ---
        const controls = {
            structure: document.getElementById('crystal-structure'),
            latticeParam: document.getElementById('lattice-parameter'),
            latticeParamValue: document.getElementById('lattice-parameter-value'),
            wavelength: document.getElementById('xray-wavelength'),
            wavelengthPreset: document.getElementById('wavelength-preset'),
            thermalFactor: document.getElementById('thermal-factor'),
            thermalFactorValue: document.getElementById('thermal-factor-value'),
            polarization: document.getElementById('polarization-factor'),
            twoThetaMin: document.getElementById('two-theta-min'),
            twoThetaMinValue: document.getElementById('two-theta-min-value'),
            twoThetaMax: document.getElementById('two-theta-max'),
            twoThetaMaxValue: document.getElementById('two-theta-max-value'),
            peakTableBody: document.getElementById('peak-table-body'),
            chartCanvas: document.getElementById('xrd-chart')
        };

        let xrdChart; // Will hold the chart instance

        // --- Main Simulation Function ---
        const runSimulation = () => {
            const params = {
                structure: controls.structure.value,
                a: parseFloat(controls.latticeParam.value),
                lambda: parseFloat(controls.wavelength.value),
                B: parseFloat(controls.thermalFactor.value),
                element: 'Si',
                polarization: controls.polarization.value,
                peakWidth: 0.15 
            };

            if (isNaN(params.a) || isNaN(params.lambda) || params.a <= 0 || params.lambda <= 0) {
                return;
            }

            const peaks = calculatePeaks(params);
            const maxIntensity = populateTable(peaks);
            plotDiffractogram(peaks, maxIntensity);
        };

        // --- Calculation Functions ---
        const calculatePeaks = (params) => {
            const { structure, a, lambda } = params;
            const calculatedPeaks = [];
            const max_hkl = 10; 

            for (let h = 0; h <= max_hkl; h++) {
                for (let k = 0; k <= h; k++) {
                    for (let l = 0; l <= k; l++) {
                        if (h === 0 && k === 0 && l === 0) continue;

                        if (isReflectionAllowed(structure, h, k, l)) {
                            const hkl_sq = h*h + k*k + l*l;
                            const d = a / Math.sqrt(hkl_sq);
                            const sinTheta = lambda / (2 * d);

                            if (sinTheta <= 1) {
                                const thetaRad = Math.asin(sinTheta);
                                const multiplicity = getMultiplicity(h, k, l);
                                let intensity = calculateIntensity(thetaRad, params, h, k, l);
                                
                                intensity *= multiplicity;

                                if (intensity > 0) {
                                    calculatedPeaks.push({
                                        two_theta: 2 * thetaRad * (180 / Math.PI),
                                        d: d, h, k, l, intensity, multiplicity
                                    });
                                }
                            }
                        }
                    }
                }
            }
            return calculatedPeaks.sort((a, b) => a.two_theta - b.two_theta);
        };
        
        const getMultiplicity = (h, k, l) => {
            let familyType;
            if (l > 0) { 
                if (h === k && k === l) { familyType = 'hhh'; } 
                else if (h === k || k === l) { familyType = 'hhl'; } 
                else { familyType = 'hkl'; }
            } else { 
                if (k === 0) { familyType = 'h00'; } 
                else { 
                    if (h === k) { familyType = 'hh0'; } 
                    else { familyType = 'hk0'; }
                }
            }
            switch (familyType) {
                case 'hkl': return 48;
                case 'hhl': return 24;
                case 'hk0': return 24;
                case 'hh0': return 12;
                case 'hhh': return 8;
                case 'h00': return 6;
                default:    return 0;
            }
        };

        const isReflectionAllowed = (structure, h, k, l) => {
            const sum = h + k + l;
            const h_even = h % 2 === 0;
            const k_even = k % 2 === 0;
            const l_even = l % 2 === 0;

            switch (structure) {
                case 'SC': return true;
                case 'BCC': return sum % 2 === 0;
                case 'FCC': return (h_even === k_even) && (k_even === l_even);
                case 'Diamond':
                    if (!((h_even === k_even) && (k_even === l_even))) return false;
                    if (h_even && k_even && l_even) return sum % 4 === 0;
                    return true;
                default: return true;
            }
        };

        const calculateIntensity = (thetaRad, params, h, k, l) => {
            const { lambda, B, element, structure, polarization } = params;
            const sinTheta = Math.sin(thetaRad);
            if (sinTheta < 1e-6) return 0;

            const cosTheta = Math.cos(thetaRad);
            if (cosTheta < 1e-6) return 0;
            
            const cos2Theta = Math.cos(2 * thetaRad);
            let p_factor;
            switch (polarization) {
                case 'linear_vertical':
                    p_factor = cos2Theta * cos2Theta;
                    break;
                case 'linear_horizontal':
                    p_factor = 1;
                    break;
                case 'unpolarized':
                default:
                    p_factor = 1 + cos2Theta * cos2Theta;
                    break;
            }
            const Lp = p_factor / (sinTheta * sinTheta * cosTheta);

            const s = sinTheta / lambda;
            const debyeWaller = Math.exp(-2 * B * s * s);

            const alphaMap = { 'Si': 3.5 };
            const Zmap = { 'Si': 14 };
            const f_amp = (Zmap[element]) * Math.exp(-(alphaMap[element]) * s * s);
            let F_sq = f_amp * f_amp;

            if (structure === 'Diamond') {
                const sum_hkl = h + k + l;
                if (sum_hkl % 4 === 2) F_sq = 0;
                else if (sum_hkl % 2 !== 0) F_sq *= 32;
                else if (sum_hkl % 4 === 0) F_sq *= 64;
            }
            
            return F_sq * Lp * debyeWaller;
        };

        // --- UI Update Functions ---
        const populateTable = (peaks) => {
            controls.peakTableBody.innerHTML = '';
            if (peaks.length === 0) {
                controls.peakTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4">No diffraction peaks found.</td></tr>`;
                return 1;
            }
            const maxIntensity = Math.max(...peaks.map(p => p.intensity));
            peaks.forEach(peak => {
                const normIntensity = (peak.intensity / maxIntensity * 100);
                const hklString = `(${peak.h},${peak.k},${peak.l})`;

                const row = `
                    <tr>
                        <td class="px-4 py-3 text-sm">${peak.two_theta.toFixed(4)}</td>
                        <td class="px-4 py-3 text-sm">${peak.d.toFixed(4)}</td>
                        <td class="px-4 py-3 text-sm">${hklString}</td>
                        <td class="px-4 py-3 text-sm text-center">${peak.multiplicity}</td>
                        <td class="px-4 py-3 text-sm">${normIntensity.toFixed(2)}</td>
                    </tr>
                `;
                controls.peakTableBody.innerHTML += row;
            });
            return maxIntensity || 1;
        };

        const plotDiffractogram = (peaks, maxIntensity) => {
            if (xrdChart) {
                xrdChart.destroy();
            }
            const peakWidth = 0.15; // FWHM is fixed as requested.
            const plotData = [];
            
            // Generate plot points over the specified calculation range with more points.
            for (let two_theta = 5; two_theta <= 160; two_theta += 0.05) {
                let y = Math.random() * 0.5; 
                peaks.forEach(peak => {
                    if (peak.intensity > 0) {
                        const normIntensity = (peak.intensity / maxIntensity * 100);
                        const stdev = peakWidth / 2.355;
                        y += normIntensity * Math.exp(-((two_theta - peak.two_theta) ** 2) / (2 * stdev * stdev));
                    }
                });
                plotData.push({ x: two_theta, y: y });
            }

            xrdChart = new Chart(controls.chartCanvas, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Intensity', data: plotData,
                        borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 1.5, pointRadius: 0, tension: 0.1, fill: true,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        x: { 
                            type: 'linear', 
                            title: { display: true, text: '2θ (degrees)', font: { size: 14 }}, 
                            min: parseFloat(controls.twoThetaMin.value), 
                            max: parseFloat(controls.twoThetaMax.value)
                        },
                        y: { 
                            title: { display: true, text: 'Intensity (a.u.)', font: { size: 14 }}, 
                            min: 0 
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
        };

        const updateChartRange = () => {
            if (!xrdChart) return;
            let min = parseFloat(controls.twoThetaMin.value);
            let max = parseFloat(controls.twoThetaMax.value);
            
            if (min >= max) {
                 min = max - 1;
                 controls.twoThetaMin.value = min;
                 controls.twoThetaMinValue.textContent = min;
            };

            xrdChart.options.scales.x.min = min;
            xrdChart.options.scales.x.max = max;
            xrdChart.update('none');
        };


        // --- Event Listeners ---
        [controls.structure, controls.latticeParam, controls.wavelength, controls.wavelengthPreset, controls.thermalFactor, controls.polarization].forEach(control => {
            control.addEventListener('input', runSimulation);
        });
        
        controls.latticeParam.addEventListener('input', () => {
            controls.latticeParamValue.textContent = controls.latticeParam.value;
        });
        controls.thermalFactor.addEventListener('input', () => {
            controls.thermalFactorValue.textContent = controls.thermalFactor.value;
        });

        controls.twoThetaMin.addEventListener('input', () => {
            controls.twoThetaMinValue.textContent = controls.twoThetaMin.value;
            updateChartRange();
        });
        controls.twoThetaMax.addEventListener('input', () => {
            controls.twoThetaMaxValue.textContent = controls.twoThetaMax.value;
            updateChartRange();
        });
        
        controls.wavelengthPreset.addEventListener('change', (e) => {
            controls.wavelength.value = e.target.value;
            runSimulation();
        });
        
        // --- Resizer Logic ---
        const resizer = document.getElementById('drag-handle');
        const leftPanel = document.getElementById('controls-panel');
        let isResizing = false;
        resizer.addEventListener('mousedown', (e) => {
            e.preventDefault(); isResizing = true;
            document.body.style.cursor = 'col-resize';
            window.addEventListener('mousemove', handleMouseMove);
            window.addEventListener('mouseup', stopResize);
        });
        function handleMouseMove(e) {
            if (isResizing && e.clientX > 320 && e.clientX < 600) {
               leftPanel.style.width = `${e.clientX}px`;
            }
        }
        function stopResize() {
            isResizing = false; document.body.style.cursor = 'default';
            window.removeEventListener('mousemove', handleMouseMove);
            window.removeEventListener('mouseup', stopResize);
        }

        // --- Initial Run ---
        runSimulation();
    });
    </script>
</body>
</html>