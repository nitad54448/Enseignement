<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Characteristic Radiations</title>
    <link href="./dist/output.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #f0f0f0;
            color: #e5e7eb; /* Default light text for dark theme */
            display: flex;
            flex-direction: column; /* Allow footer to sit below */
            height: 100vh;
            overflow: hidden;
        }
        #app-container {
            display: flex;
            width: 100%;
            flex-grow: 1; /* Take up remaining vertical space */
            min-height: 0;
        }
        #controls-panel {
            width: 350px;
            min-width: 280px;
            max-width: 600px;
            flex-shrink: 0;
            padding: 24px;
            background-color: #111827; /* Dark blue-gray */
            border-right: 1px solid #374151;
            overflow-y: auto;
            color: #d1d5db;
        }
        #drag-handle {
            width: 6px;
            cursor: col-resize;
            background-color: #374151;
            flex-shrink: 0;
            transition: background-color 0.2s;
        }
        #drag-handle:hover {
            background-color: #3b82f6;
        }
        #visualization-area {
            flex-grow: 1;
            position: relative;
            background-color: #ffffff;
            min-width: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            color: #1f2937; /* Dark text for light theme */
            overflow: hidden;
        }
        .canvas-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 900px; /* Max width for the diagram */
            margin: auto;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            cursor: default;
        }
        /* Dark Theme Controls Styling */
        #controls-panel h1 { font-size: 1.8em; margin-bottom: 8px; font-weight: 700; color: #ffffff; }
        #controls-panel > p { font-size: 0.9em; margin-bottom: 24px; color: #9ca3af; }
        #controls-panel h2 { font-size: 1.25em; font-weight: 600; margin-bottom: 16px; border-bottom: 1px solid #374151; padding-bottom: 8px; color: #ffffff;}
        /* This rule now only applies to labels that are direct children of a control-group */
        #controls-panel .control-group > label { display: block; margin-bottom: 8px; font-weight: 500; color: #9ca3af; }
        #controls-panel select, #controls-panel input[type="number"] {
            width: 100%;
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #e5e7eb;
            border-radius: 0.375rem;
            padding: 0.6rem;
        }
        .control-group {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            background-color: rgba(255, 255, 255, 0.05);
        }
        .rules-list {
            list-style-type: none;
            padding-left: 0;
            color: #d1d5db;
            font-size: 0.9em;
        }
        .rules-list li {
            margin-bottom: 0.25rem;
            font-family: monospace;
        }
        #transitionInfo {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: #1f2937;
            border-radius: 0.375rem;
            min-height: 80px;
            font-size: 0.9em;
            line-height: 1.5;
            color: #a5b4fc;
        }
        .canvas-tooltip {
            position: absolute;
            display: none;
            background-color: rgba(20, 20, 20, 0.85);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9em;
            pointer-events: none;
            z-index: 1000;
            font-family: 'Consolas', 'Menlo', monospace;
        }
        footer {
            width: 100%;
            background-color: #ffffff;
            padding: 8px 24px;
            text-align: left; /* Justified to the left */
            font-size: 0.8em;
            color: #4b5563;
            border-top: 1px solid #e5e7eb;
            flex-shrink: 0;
        }
    </style>
</head>
<body>

    <div id="app-container">
        <div id="controls-panel">
            <h1>Characteristic Radiations</h1>
            <p>Visualize atomic energy levels and allowed transitions.</p>

            <div class="control-group">
                <div class="flex items-center mb-4">
                    <label for="elementSelect" class="w-24 flex-shrink-0 font-medium text-gray-400">Source</label>
                    <select id="elementSelect" class="ml-4 flex-1"></select>
                </div>
                <div class="flex items-center">
                    <label for="transitionSelect" class="w-24 flex-shrink-0 font-medium text-gray-400">Transition</label>
                    <select id="transitionSelect" class="ml-4 flex-1">
                        <option value="none">None</option>
                        <option value="Ka1">Kα1 (L3 → K)</option>
                        <option value="Ka2">Kα2 (L2 → K)</option>
                        <option value="Kb1">Kβ1 (M3 → K)</option>
                        <option value="La1">Lα1 (M5 → L3)</option>
                        <option value="Lb1">Lβ1 (M4 → L2)</option>
                    </select>
                </div>
            </div>
            
            <div class="control-group">
                <h3 class="font-semibold text-lg text-white mb-2">Selection Rules</h3>
                <ul class="rules-list">
                    <li>Δn ≠ 0</li>
                    <li>Δl = ±1</li>
                    <li>Δj = 0, ±1</li>
                    <li>(j=0 ↔ j=0 forbidden)</li>
                </ul>
            </div>

            <div id="transitionInfo">
                Select a transition to see its energy and wavelength.
            </div>
        </div>

        <div id="drag-handle"></div>

        <div id="visualization-area">
            <h2 class="text-2xl font-bold mb-4 text-center">Atomic Energy Level Diagram</h2>
            <div class="canvas-wrapper">
                <canvas id="energyDiagramCanvas"></canvas>
            </div>
        </div>
    </div>

    <footer class="text-gray-600">
        NitaD, Univ Paris-Saclay, version August 8, 2025
    </footer>

    <div id="tooltip" class="canvas-tooltip"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Data ---
            const elementEnergyLevels = { // in eV
                "Mn": { K: 6539, L1: 769.1, L2: 650.8, L3: 638.7, M1: 84.3, M2: 47.2, M3: 47.2, M4:3.0, M5:3.0 }, 
                "Fe": { K: 7112, L1: 846.1, L2: 721.1, L3: 708.1, M1: 91.4, M2: 52.7, M3: 52.7, M4:4.0, M5:4.0 }, 
                "Co": { K: 7709, L1: 927.8, L2: 793.4, L3: 778.1, M1: 101.0, M2: 60.0, M3: 60.0, M4:4.0, M5:4.0 },
                "Ni": { K: 8333, L1: 1008.6,L2: 871.9, L3: 854.7, M1: 110.8, M2: 68.0, M3: 66.2, M4:5.0, M5:5.0 },
                "Cu": { K: 8979, L1: 1096.7,L2: 952.3, L3: 932.7, M1: 122.5, M2: 77.3, M3: 75.1, M4:5.0, M5:5.0 },
                "Zn": { K: 9659, L1: 1196.2,L2: 1044.9,L3: 1021.8,M1: 139.8, M2: 91.3, M3: 88.6, M4:10.1,M5:10.1},
                "Mo": { K: 20000,L1: 2866,  L2: 2625, L3: 2520, M1: 505, M2: 410, M3: 392, M4: 230, M5: 227 },
                "Au": { K: 80725,L1: 14353, L2: 13734,L3: 11919,M1: 3425, M2: 3148, M3: 2743, M4: 2291, M5: 2206 }
            };

            const transitionsData = {
                "Ka1": { from: "L3", to: "K", label: "Kα1" }, "Ka2": { from: "L2", to: "K", label: "Kα2" },
                "Kb1": { from: "M3", to: "K", label: "Kβ1" }, "La1": { from: "M5", to: "L3", label: "Lα1" }, 
                "Lb1": { from: "M4", to: "L2", label: "Lβ1" }  
            };
            
            const levelQuantumNumbers = {
                K:  { n: 1, l: 0, j: "1/2" }, L1: { n: 2, l: 0, j: "1/2" }, L2: { n: 2, l: 1, j: "1/2" },
                L3: { n: 2, l: 1, j: "3/2" }, M1: { n: 3, l: 0, j: "1/2" }, M2: { n: 3, l: 1, j: "1/2" },
                M3: { n: 3, l: 1, j: "3/2" }, M4: { n: 3, l: 2, j: "3/2" }, M5: { n: 3, l: 2, j: "5/2" },
                N1: { n: 4, l: 0, j: "1/2" }, N2: { n: 4, l: 1, j: "1/2" }, N3: { n: 4, l: 1, j: "3/2" },
                N4: { n: 4, l: 2, j: "3/2" }, N5: { n: 4, l: 2, j: "5/2" },
            };

            const levelConfigurations = {
                'K':  '1s', 'L1': '2s', 'L2': '2p', 'L3': '2p',
                'M1': '3s', 'M2': '3p', 'M3': '3p', 'M4': '3d', 'M5': '3d',
                'N1': '4s', 'N2': '4p', 'N3': '4p', 'N4': '4d', 'N5': '4d',
            };

            const HC_EV_A = 12398.4198; 

            // --- DOM Elements ---
            const canvas = document.getElementById('energyDiagramCanvas');
            const ctx = canvas.getContext('2d');
            const elementSelect = document.getElementById('elementSelect');
            const transitionSelect = document.getElementById('transitionSelect');
            const transitionInfoDiv = document.getElementById('transitionInfo'); 
            const tooltip = document.getElementById('tooltip');
            let hittableLevels = [];

            // --- Drawing Constants ---
            // Y positions are now percentages from the top of the canvas.
            // E0 (Continuum) is at the top (lowest percentage), K-shell is at the bottom (highest percentage).
            const levelYPosition = { 
                E0: 0.08, Valence: 0.13, O: 0.20,
                N5: 0.30, N4: 0.33, N3: 0.36, N2: 0.39, N1: 0.42,
                M5: 0.54, M4: 0.57, M3: 0.60, M2: 0.63, M1: 0.66,
                L3: 0.78, L2: 0.81, L1: 0.84,
                K: 0.92
            };

            // --- Functions ---
            function setCanvasSize() {
                const container = canvas.parentElement;
                const dpr = window.devicePixelRatio || 1;
                const rect = container.getBoundingClientRect();
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                drawDiagram();
            }

            function populateElementSelect() {
                Object.keys(elementEnergyLevels).forEach(el => {
                    const option = document.createElement('option');
                    option.value = el; option.textContent = el; elementSelect.appendChild(option);
                });
                elementSelect.value = "Cu"; 
            }

            function drawDiagram() {
                const selectedElementKey = elementSelect.value;
                const selectedTransitionKey = transitionSelect.value;
                const levels = elementEnergyLevels[selectedElementKey];

                const canvasWidth = canvas.parentElement.clientWidth;
                const canvasHeight = canvas.parentElement.clientHeight;
                const levelWidth = Math.min(300, canvasWidth * 0.4);
                const levelXPosition = (canvasWidth - levelWidth) / 2;

                ctx.clearRect(0, 0, canvasWidth, canvasHeight);
                ctx.font = "14px Inter";
                ctx.textAlign = "left";
                transitionInfoDiv.innerHTML = "Select a transition to see its energy and wavelength."; 
                hittableLevels = [];

                const existingLevelsInElement = Object.keys(levels);

                for (const levelKey in levelYPosition) {
                    if (levelKey === "E0" || existingLevelsInElement.includes(levelKey) || 
                        (levelKey.startsWith("M") && existingLevelsInElement.some(elKey => elKey.startsWith("M"))) || 
                        (levelKey.startsWith("N") && existingLevelsInElement.some(elKey => elKey.startsWith("N"))) || 
                        (levelKey.startsWith("O") && existingLevelsInElement.some(elKey => elKey.startsWith("O"))) ) { 
                        
                        // Y position is now calculated directly from the top.
                        const y = levelYPosition[levelKey] * canvasHeight;

                        ctx.beginPath();
                        ctx.moveTo(levelXPosition, y);
                        ctx.lineTo(levelXPosition + levelWidth, y);
                        ctx.strokeStyle = "#555";
                        ctx.lineWidth = (levelKey === "E0" || levelKey === "Valence") ? 1 : 2;
                        ctx.stroke();
                        
                        const config = levelConfigurations[levelKey];
                        if (config) {
                             hittableLevels.push({
                                yMin: y - 5, yMax: y + 5, xMin: levelXPosition,
                                xMax: levelXPosition + levelWidth, html: `Configuration: ${config}`
                            });
                        }

                        const qn = levelQuantumNumbers[levelKey];
                        if (qn) {
                            ctx.fillStyle = "#4b5563";
                            ctx.textAlign = "right";
                            ctx.fillText(`n=${qn.n}, l=${qn.l}, j=${qn.j}`, levelXPosition - 15, y + 4);
                        }
                        
                        ctx.textAlign = "left";
                        ctx.fillStyle = "#1f2937";
                        let labelText = levelKey;
                        if (levels[levelKey] !== undefined) {
                            let energyDisplay = levels[levelKey] > 1000 ? (levels[levelKey]/1000).toFixed(3) + " keV" : levels[levelKey].toFixed(1) + " eV";
                            labelText += ` (${energyDisplay})`;
                        } else if (levelKey === "E0") {
                             labelText = "E=0 (Continuum)";
                        } else if (levelKey === "Valence") {
                             labelText = "Valence Band";
                        }
                        ctx.fillText(labelText, levelXPosition + levelWidth + 10, y + 4);
                    }
                }
                
                if (selectedTransitionKey !== "none" && transitionsData[selectedTransitionKey]) {
                    const transition = transitionsData[selectedTransitionKey];
                    const fromLevelKey = transition.from;
                    const toLevelKey = transition.to;

                    if (levels[fromLevelKey] !== undefined && levels[toLevelKey] !== undefined && 
                        levelYPosition[fromLevelKey] && levelYPosition[toLevelKey]) {
                        
                        const yFrom = levelYPosition[fromLevelKey] * canvasHeight;
                        const yTo = levelYPosition[toLevelKey] * canvasHeight; 
                        const arrowX = levelXPosition + levelWidth / 2 + (Object.keys(transitionsData).indexOf(selectedTransitionKey) -2) * 25 ;

                        // Draw arrow line
                        ctx.beginPath(); ctx.moveTo(arrowX, yFrom); ctx.lineTo(arrowX, yTo);
                        ctx.strokeStyle = "#ef4444"; ctx.lineWidth = 2.5; ctx.stroke();
                        
                        // Draw arrowhead
                        const headlen = 10; 
                        const angle = Math.atan2(yTo - yFrom, 0); // Angle for a downward vertical arrow
                        ctx.beginPath();
                        ctx.moveTo(arrowX, yTo);
                        ctx.lineTo(arrowX - headlen * Math.cos(angle - Math.PI / 6), yTo - headlen * Math.sin(angle - Math.PI / 6));
                        ctx.moveTo(arrowX, yTo);
                        ctx.lineTo(arrowX - headlen * Math.cos(angle + Math.PI / 6), yTo - headlen * Math.sin(angle + Math.PI / 6));
                        ctx.strokeStyle = "#ef4444"; ctx.stroke();
                        
                        // Draw label next to the arrow
                        ctx.fillStyle = "#b91c1c"; // Darker red for text
                        ctx.textAlign = "left";
                        ctx.textBaseline = "middle";
                        ctx.fillText(transition.label, arrowX + 15, (yFrom + yTo) / 2);

                        const energyFrom_eV = levels[fromLevelKey]; const energyTo_eV = levels[toLevelKey];
                        const transitionEnergy_eV = Math.abs(energyTo_eV - energyFrom_eV); 

                        if (transitionEnergy_eV > 0) {
                            const wavelength_A = HC_EV_A / transitionEnergy_eV;
                            let energyDisplayUnit = "eV"; let energyValueDisplay = transitionEnergy_eV;
                            if (transitionEnergy_eV > 1000) {
                                energyValueDisplay = transitionEnergy_eV / 1000; energyDisplayUnit = "keV";
                            }
                            
                            transitionInfoDiv.innerHTML = `<strong class="text-white">Transition ${transition.label}</strong><br>
                                Energy: ${energyValueDisplay.toFixed(3)} ${energyDisplayUnit}<br>
                                Wavelength (λ): ${wavelength_A.toFixed(4)} Å`;
                        }
                    } else {
                         transitionInfoDiv.innerHTML = `Level data insufficient for the transition ${transition.label} for ${selectedElementKey}.`;
                    }
                }
            }

            function handleCanvasMouseMove(e) {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                let levelFound = false;

                for (const level of hittableLevels) {
                    if (mouseY >= level.yMin && mouseY <= level.yMax &&
                        mouseX >= level.xMin && mouseX <= level.xMax) {
                        
                        tooltip.innerHTML = level.html;
                        tooltip.style.display = 'block';
                        tooltip.style.left = `${e.pageX + 15}px`;
                        tooltip.style.top = `${e.pageY + 15}px`;
                        canvas.style.cursor = 'pointer';
                        levelFound = true;
                        break;
                    }
                }

                if (!levelFound) {
                    tooltip.style.display = 'none';
                    canvas.style.cursor = 'default';
                }
            }

            function handleCanvasMouseOut() {
                tooltip.style.display = 'none';
                canvas.style.cursor = 'default';
            }

            // --- Event Listeners ---
            elementSelect.addEventListener('change', drawDiagram);
            transitionSelect.addEventListener('change', drawDiagram);
            canvas.addEventListener('mousemove', handleCanvasMouseMove);
            canvas.addEventListener('mouseout', handleCanvasMouseOut);

            // --- Resizer Logic ---
            const resizer = document.getElementById('drag-handle');
            const leftPanel = document.getElementById('controls-panel');
            let isResizing = false;

            resizer.addEventListener('mousedown', e => {
                e.preventDefault();
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                window.addEventListener('mousemove', handleMouseMove);
                window.addEventListener('mouseup', stopResize);
            });

            function handleMouseMove(e) {
                if (!isResizing) return;
                const container = resizer.parentElement;
                const newLeftWidth = e.clientX - container.getBoundingClientRect().left;
                // Add constraints for min/max width
                if (newLeftWidth > 280 && newLeftWidth < container.clientWidth - 400) {
                    leftPanel.style.width = `${newLeftWidth}px`;
                    setCanvasSize(); // Redraw on resize
                }
            }

            function stopResize() {
                isResizing = false;
                document.body.style.cursor = 'default';
                document.body.style.userSelect = 'auto';
                window.removeEventListener('mousemove', handleMouseMove);
                window.removeEventListener('mouseup', stopResize);
            }

            // --- Initialization ---
            populateElementSelect();
            
            // Use ResizeObserver for more robust canvas resizing
            const ro = new ResizeObserver(setCanvasSize);
            ro.observe(canvas.parentElement);

            // Initial draw
            setCanvasSize();
        });
    </script>
</body>
</html>