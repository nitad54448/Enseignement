<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>indeXman</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --system-blue: #007AFF;
            --system-red: #FF3B30;
            --system-gray-1: #8E8E93;
            --system-gray-2: #AEAEB2;
            --system-gray-3: #C7C7CC;
            --system-gray-4: #D1D1D6;
            --system-gray-5: #E5E5EA;
            --system-gray-6: #F2F2F7;
            --system-background: #FFFFFF;
            --system-grouped-background: #F2F2F7;
            --system-label: #000000;
            --system-secondary-label: rgba(60, 60, 67, 0.6);
            --system-separator: rgba(60, 60, 67, 0.29);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
            margin: 0;
            background-color: var(--system-grouped-background);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            color: var(--system-label);
        }

        #app-container {
            display: flex;
            width: 100%;
            flex-grow: 1;
            min-height: 0;
            background-color: var(--system-grouped-background);
        }

        #controls-panel {
            width: 380px;
            min-width: 320px;
            max-width: 500px;
            flex-shrink: 0;
            padding: 16px;
            background-color: var(--system-background);
            border-right: 1px solid var(--system-separator);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            position: relative;
            z-index: 20;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
            border-radius: 0 12px 12px 0;
        }

        #drag-handle {
            width: 6px;
            cursor: col-resize;
            background-color: var(--system-gray-5);
            flex-shrink: 0;
            transition: background-color 0.2s;
        }

        #drag-handle:hover,
        #drag-handle:active {
            background-color: var(--system-blue);
        }

        #results-area {
            flex-grow: 1;
            position: relative;
            background-color: var(--system-background);
            min-width: 0;
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 10;
            border-radius: 12px 0 0 12px;
            margin: 8px 8px 8px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .control-group {
            padding: 16px;
            margin-bottom: 16px;
            background-color: var(--system-background);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .control-group:first-child {
            padding-top: 0;
            margin-top: 0;
        }
        
        .tab-content-panel .control-group {
             box-shadow: none;
             padding: 0;
             margin-bottom: 0;
        }
        
        .control-label {
            display: block;
            font-weight: 500;
            color: var(--system-secondary-label);
            font-size: 13px;
            margin-bottom: 6px;
        }

        .control-input,
        .control-select {
            width: 100%;
            background-color: var(--system-gray-6);
            border: 1px solid var(--system-gray-4);
            color: var(--system-label);
            border-radius: 8px;
            padding: 10px 14px;
            transition: all 0.2s ease;
            box-sizing: border-box;
            font-size: 15px;
            height: 40px;
        }

        .control-input:focus,
        .control-select:focus {
            outline: none;
            border-color: var(--system-blue);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }

        .btn {
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            text-align: center;
            font-size: 15px;
            height: 44px;
        }
        
        .btn-primary { 
            background-color: var(--system-blue); 
            color: white; 
            box-shadow: 0 1px 3px rgba(0, 122, 255, 0.3);
        }
        .btn-primary:hover:not(:disabled) { 
            background-color: #006ee6; 
        }

        .btn-secondary {
            background-color: var(--system-gray-6);
            color: var(--system-label);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: var(--system-gray-5);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn:disabled {
            background-color: var(--system-gray-6);
            color: var(--system-gray-3);
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
        }

        .file-input-label {
            display: block;
            padding: 12px 16px;
            background-color: var(--system-gray-6);
            color: var(--system-label);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            border: 1px dashed var(--system-gray-4);
        }

        .file-input-label:hover {
            background-color: var(--system-gray-5);
            border-color: var(--system-blue);
        }

        .control-group h2 {
            margin: 0 0 16px 0;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--system-separator);
            color: var(--system-label);
            font-size: 17px;
            font-weight: 600;
        }
        
        .form-row {
            display: grid;
            gap: 12px;
            align-items: center;
            grid-template-columns: minmax(100px, auto) 1fr;
        }

        .form-row>.control-label {
            grid-column: 1;
            margin-bottom: 0;
        }

        #lattice-parameters-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .parameter-grid {
            display: grid;
            grid-template-columns: minmax(100px, auto) 1fr;
            gap: 12px;
            align-items: center;
        }

        .parameter-grid>.control-label {
            margin-bottom: 0;
        }
        
        #lattice-parameters-container .parameter-grid {
             grid-template-columns: minmax(100px, auto) 1fr;
        }

        .bottom-actions {
            margin-top: auto;
            padding-top: 16px;
        }
        
        .bottom-actions-wrapper {
            padding: 0 20px;
        }

        .help-tooltip-container {
            position: relative;
            display: inline-block;
        }

        .help-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background-color: #4a5568;
            color: white;
            border-radius: 50%;
            font-weight: 500;
            font-size: 14px;
            cursor: help;
            transition: all 0.2s;
        }

        .help-icon:hover {
            background-color: #2d3748;
        }

        .tooltip-content {
            visibility: hidden;
            opacity: 0;
            width: 280px;
            background-color: #2d3748;
            color: #f7fafc;
            text-align: left;
            border-radius: 10px;
            padding: 16px;
            position: absolute;
            z-index: 1001;
            top: -15px;
            right: 115%;
            margin-right: 10px;
            transition: opacity 0.3s;
            font-size: 15px;
            border: 1px solid #4a5568;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .tooltip-content::after {
            content: "";
            position: absolute;
            top: 20px;
            left: 100%;
            margin-top: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent transparent #2d3748;
        }

        .tooltip-content.visible {
            visibility: visible;
            opacity: 1;
        }
        .tooltip-content h4 { margin-top: 0; margin-bottom: 8px; font-weight: 600; }
        .tooltip-content p { margin: 0 0 6px 0; line-height: 1.4; color: #e2e8f0;}
        .tooltip-content hr { border: none; border-top: 1px solid #4a5568; margin: 12px 0; }
        
        .hidden { display: none !important; }

        #controls-panel::-webkit-scrollbar { width: 5px; }
        #controls-panel::-webkit-scrollbar-track { background: transparent; }
        #controls-panel::-webkit-scrollbar-thumb { background: var(--system-gray-4); border-radius: 3px; }
        #controls-panel::-webkit-scrollbar-thumb:hover { background: var(--system-gray-3); }

        #placeholder {
            background-color: var(--system-background);
            border-radius: 12px;
            padding: 40px;
        }
        #placeholder svg { color: var(--system-gray-3); }
        .control-group { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Tab Styles */
        .tab-buttons { 
            display: flex; 
            background-color: var(--system-gray-6);
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 16px;
        }
        .tab-btn { 
            flex: 1; 
            padding: 8px 12px; 
            background: none; 
            border: none; 
            color: var(--system-secondary-label); 
            font-weight: 500; 
            cursor: pointer; 
            border-radius: 8px;
            transition: all 0.2s; 
            font-size: 14px; 
        }
        .tab-btn:hover { 
            color: var(--system-label); 
            background-color: rgba(255,255,255,0.5);
        }
        .tab-btn.active { 
            color: var(--system-blue); 
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .tab-content-panels { 
            position: relative; 
            padding-top: 0; 
        }
        .tab-content-panel { 
            display: none; 
        }
        .tab-content-panel.active { 
            display: block; 
        }

        /* Slider Styles */
        .slider-value-track { 
            display: grid; grid-template-columns: 1fr; grid-template-rows: 1fr; align-items: center; 
        }
        .slider-value-track > * { grid-column: 1; grid-row: 1; }
        .slider-value-display { 
            text-align: center; color: var(--system-secondary-label); font-weight: 500; font-size: 13px; pointer-events: none; 
        }
        input[type="range"].custom-slider { 
            -webkit-appearance: none; appearance: none; width: 100%; height: 36px; background: var(--system-gray-6); border-radius: 6px; outline: none; padding: 0; margin: 0; 
        }
        input[type="range"].custom-slider::-webkit-slider-thumb { 
            -webkit-appearance: none; appearance: none; width: 22px; height: 22px; background: var(--system-blue); border-radius: 50%; cursor: pointer; border: 3px solid white; box-sizing: border-box; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        input[type="range"].custom-slider::-moz-range-thumb { 
            width: 22px; height: 22px; background: var(--system-blue); border-radius: 50%; cursor: pointer; border: 3px solid white; box-sizing: border-box; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

    </style>
</head>

<body>

    <div id="app-container">
        <div id="controls-panel">

            <div class="control-group" style="padding-top: 16px; padding-bottom: 0;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label for="file-input" class="file-input-label" style="flex-grow: 1;">
                        <span id="file-name">Select Data File</span>
                    </label>
                    <div class="help-tooltip-container">
                        <span class="help-icon">?</span>
                        <div class="tooltip-content">
                            <h4>IndexMan v1.3</h4>
                            <p>Visually compare experimental peaks with calculated hkl positions to determine unit cell parameters.</p>
                            <hr>
                            <h4>Supported File Formats:</h4>
                            <p>Generic 2-column (2θ intensity), .xrdml, .brml, .ras, .uxd, .udf, GSAS .esd/.xra</p>
                            <hr>
                            <h4>Chart Interaction:</h4>
                            <p><b>Zoom:</b> Use the mouse wheel over an axis.</p>
                            <p><b>Pan:</b> Click and drag the chart to pan.</p>
                            <p><b>Reset View:</b> Right-click on the chart.</p>
                            <p><b>HKL Info:</b> Hover over any peak marker.</p>
                        </div>
                    </div>
                </div>
                <input type="file" id="file-input" class="hidden" accept=".brml,.csv,.ras,.txt,.esd,.gsa,.std,.udf,.xra,.xrdml,.xy">
            </div>

            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="sample">Sample</button>
                <button class="tab-btn" data-tab="instrument">Instrument</button>
                <button class="tab-btn" data-tab="background">Background</button>
            </div>

            <div class="tab-content-panels">
                <div id="tab-panel-sample" class="tab-content-panel active">
                    <div class="control-group">
                        <h2>Structural Parameters</h2>
                        <div class="parameter-grid">
                            <label for="bravais-lattice" class="control-label">System</label>
                            <select id="bravais-lattice" class="control-select">
                                <option value="cubic_F" selected>Cubic (F)</option>
                                <option value="cubic_I">Cubic (I)</option>
                                <option value="cubic_P">Cubic (P)</option>
                                <option value="hexagonal_P">Hexagonal (P)</option>
                                <option value="rhombohedral_P">Rhombohedral (H-axes)</option>
                                <option value="tetragonal_I">Tetragonal (I)</option>
                                <option value="tetragonal_P">Tetragonal (P)</option>
                                <option value="orthorhombic_F">Orthorhombic (F)</option>
                                <option value="orthorhombic_I">Orthorhombic (I)</option>
                                <option value="orthorhombic_C">Orthorhombic (C)</option>
                                <option value="orthorhombic_P">Orthorhombic (P)</option>
                                <option value="monoclinic_C">Monoclinic (C)</option>
                                <option value="monoclinic_P">Monoclinic (P)</option>
                            </select>
                        </div>
                        <div class="parameter-grid" style="margin-top: 12px;">
                            <label for="space-group-select" class="control-label">Space Group</label>
                            <select id="space-group-select" class="control-select"></select>
                        </div>
                        <div id="lattice-parameters-container" style="margin-top: 16px;">
                        </div>
                    </div>
                </div>

                <div id="tab-panel-instrument" class="tab-content-panel">
                    <div class="control-group">
                        <h2>Instrumental Parameters</h2>
                        <div class="form-row">
                            <label for="zero-shift" class="control-label">Zero (°)</label>
                            <input type="number" id="zero-shift" value="0.0" step="0.001" class="control-input">
                        </div>
                         <div class="form-row" style="margin-top: 12px;">
                            <label for="wavelength" class="control-label">Radiation 1 (Å)</label>
                            <input type="number" id="wavelength" value="1.54056" step="0.0001" class="control-input" min="0.01" title="Cu K-alpha 1">
                        </div>
                         <div class="form-row" style="margin-top: 12px;">
                            <label for="wavelength2" class="control-label">Radiation 2 (Å)</label>
                            <input type="number" id="wavelength2" value="1.54439" step="0.0001" class="control-input" min="0.01" title="Cu K-alpha 2">
                        </div>
                         <div class="form-row" style="margin-top: 12px;">
                            <label for="ratio21" class="control-label">Ratio (I₂/I₁)</label>
                            <input type="number" id="ratio21" value="0.0" step="0.01" class="control-input" min="0">
                        </div>
                    </div>
                </div>

                <div id="tab-panel-background" class="tab-content-panel">
                    <div class="control-group">
                        <h2>Background & Peak Finding</h2>
                        <div class="form-row">
                           <label for="rolling-ball-window" class="control-label">BG Window</label>
                           <div class="slider-value-track">
                              <input type="range" id="rolling-ball-window" min="1" max="100" value="20" step="1" class="custom-slider">
                              <span id="rolling-ball-window-value" class="slider-value-display">20 pts</span>
                           </div>
                       </div>
                        <div class="form-row" style="margin-top: 12px;">
                           <label for="peak-threshold" class="control-label">Peak Threshold</label>
                           <div class="slider-value-track">
                               <input type="range" id="peak-threshold" min="0.1" max="20" value="2" step="0.1" class="custom-slider">
                               <span id="peak-threshold-value" class="slider-value-display">2.0 %</span>
                           </div>
                       </div>
                    </div>
                </div>
            </div>

            <div class="bottom-actions">
                <div class="bottom-actions-wrapper">
                    <button id="save-report-button" class="btn btn-secondary" style="width: 100%;" disabled>Save Text Report</button>
                </div>
            </div>
        </div>


        <div id="drag-handle"></div>

        <div id="results-area">
            <div id="placeholder" style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: var(--system-secondary-label);">
                <svg xmlns="http://www.w3.org/2000/svg" style="width: 64px; height: 64px; margin-bottom: 16px;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
                <h2 style="font-size: 22px; font-weight: 600; margin-bottom: 8px;">Awaiting Data</h2>
                <p style="font-size: 16px; color: var(--system-secondary-label);">Load a data file to begin simulation.</p>
            </div>
            <div id="results-container" style="width: 100%; height: 100%; display: none; flex-direction: column; position: relative;">
                <canvas id="main-chart"></canvas>
            </div>
             <div style="position: absolute; bottom: 6px; right: 12px; font-size: 10px; color: var(--system-secondary-label);">
                1.4, 06 Oct 2025
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- DOM Elements ---
    const controls = {
        fileInput: document.getElementById('file-input'),
        fileName: document.getElementById('file-name'),
        bravaisLattice: document.getElementById('bravais-lattice'),
        spaceGroupSelect: document.getElementById('space-group-select'),
        latticeParamsContainer: document.getElementById('lattice-parameters-container'),
        wavelength: document.getElementById('wavelength'),
        wavelength2: document.getElementById('wavelength2'),
        ratio21: document.getElementById('ratio21'),
        zeroShift: document.getElementById('zero-shift'),
        rollingBallWindow: document.getElementById('rolling-ball-window'),
        rollingBallWindowValue: document.getElementById('rolling-ball-window-value'),
        peakThreshold: document.getElementById('peak-threshold'),
        peakThresholdValue: document.getElementById('peak-threshold-value'),
        saveReportButton: document.getElementById('save-report-button'),
        mainChartCanvas: document.getElementById('main-chart'),
        placeholder: document.getElementById('placeholder'),
        resultsContainer: document.getElementById('results-container'),
    };
    
    // --- Global State ---
    let fullExperimentalData = { tth: [], intensity: [], intensity_sqrt: [] };
    let mainChart;
    let masterHklList = [];

    const spaceGroups = [
    {"number": 1, "name": "P1", "system": "triclinic", "laue_class": "-1", "rule_tree": {}},
    {"number": 2, "name": "P-1", "system": "triclinic", "laue_class": "-1", "rule_tree": {}},
    {"number": 3, "name": "P2", "system": "monoclinic", "laue_class": "2/m", "rule_tree": {}},
    {"number": 4, "name": "P21", "system": "monoclinic", "laue_class": "2/m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "0k0", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}},
    {"number": 5, "name": "C2", "system": "monoclinic", "laue_class": "2/m", "rule_tree": {"type": "expression_check", "expression": "h+k", "divisor": 2}},
    {"number": 6, "name": "Pm", "system": "monoclinic", "laue_class": "2/m", "rule_tree": {}},
    {"number": 7, "name": "Pc", "system": "monoclinic", "laue_class": "2/m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 8, "name": "Cm", "system": "monoclinic", "laue_class": "2/m", "rule_tree": {"type": "expression_check", "expression": "h+k", "divisor": 2}},
    {"number": 9, "name": "Cc", "system": "monoclinic", "laue_class": "2/m", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 10, "name": "P2/m", "system": "monoclinic", "laue_class": "2/m", "rule_tree": {}},
    {"number": 11, "name": "P21/m", "system": "monoclinic", "laue_class": "2/m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "0k0", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}},
    {"number": 12, "name": "C2/m", "system": "monoclinic", "laue_class": "2/m", "rule_tree": {"type": "expression_check", "expression": "h+k", "divisor": 2}},
    {"number": 13, "name": "P2/c", "system": "monoclinic", "laue_class": "2/m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 14, "name": "P21/c", "system": "monoclinic", "laue_class": "2/m", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0k0", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}]}},
    {"number": 15, "name": "C2/c", "system": "monoclinic", "laue_class": "2/m", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 16, "name": "P222", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {}},
    {"number": 17, "name": "P2221", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 18, "name": "P21212", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0k0", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}]}},
    {"number": 19, "name": "P212121", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0k0", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 20, "name": "C2221", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 21, "name": "C222", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"type": "expression_check", "expression": "h+k", "divisor": 2}},
    {"number": 22, "name": "F222", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "parity", "rule": "all_even"}, {"type": "parity", "rule": "all_odd"}]}},
    {"number": 23, "name": "I222", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"type": "expression_check", "expression": "h+k+l", "divisor": 2}},
    {"number": 24, "name": "I212121", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0k0", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 25, "name": "Pmm2", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {}},
    {"number": 26, "name": "Pmc21", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0k0", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}]}},
    {"number": 27, "name": "Pcc2", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 28, "name": "Pma2", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}},
    {"number": 29, "name": "Pca21", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 30, "name": "Pnc2", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h+k", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 31, "name": "Pmn21", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0k0", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}]}},
    {"number": 32, "name": "Pba2", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}},
    {"number": 33, "name": "Pna21", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k+l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}]}},
    {"number": 34, "name": "Pnn2", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "h+l", "divisor": 2}]}},
    {"number": 35, "name": "Cmm2", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"type": "expression_check", "expression": "h+k", "divisor": 2}},
    {"number": 36, "name": "Cmc21", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0k0", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}]}},
    {"number": 37, "name": "Ccc2", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 38, "name": "Amm2", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"type": "expression_check", "expression": "k+l", "divisor": 2}},
    {"number": 39, "name": "Abm2", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}]}},
    {"number": 40, "name": "Ama2", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}]}},
    {"number": 41, "name": "Aea2", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 42, "name": "Fmm2", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "parity", "rule": "all_even"}, {"type": "parity", "rule": "all_odd"}]}},
    {"number": 43, "name": "Fdd2", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "parity", "rule": "all_even"}, {"type": "parity", "rule": "all_odd"}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k+l", "divisor": 4}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "h+l", "divisor": 4}]}]}},
    {"number": 44, "name": "Imm2", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"type": "expression_check", "expression": "h+k+l", "divisor": 2}},
    {"number": 45, "name": "Iba2", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}]}},
    {"number": 46, "name": "Ima2", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}]}},
    {"number": 47, "name": "Pmmm", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {}},
    {"number": 48, "name": "Pnnn", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k+l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "h+l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h+k", "divisor": 2}]}]}},
    {"number": 49, "name": "Pccm", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 50, "name": "Pban", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h+k", "divisor": 2}]}]}},
    {"number": 51, "name": "Pmma", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}},
    {"number": 52, "name": "Pnna", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k+l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}]}},
    {"number": 53, "name": "Pmna", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 54, "name": "Pcca", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}]}},
    {"number": 55, "name": "Pbam", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}},
    {"number": 56, "name": "Pccn", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k+l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "h+l", "divisor": 2}]}]}},
    {"number": 57, "name": "Pbcm", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 58, "name": "Pnnm", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "h+l", "divisor": 2}]}},
    {"number": 59, "name": "Pmmn", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0k0", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}]}},
    {"number": 60, "name": "Pbcn", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h+k", "divisor": 2}]}]}},
    {"number": 61, "name": "Pbca", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}]}},
    {"number": 62, "name": "Pnma", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k+l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}]}},
    {"number": 63, "name": "Cmcm", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 64, "name": "Cmce", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"logic": "AND", "rules": [{"type": "expression_check", "expression": "k", "divisor": 2}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 65, "name": "Cmmm", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"type": "expression_check", "expression": "h+k", "divisor": 2}},
    {"number": 66, "name": "Cccm", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 67, "name": "Cmma", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}]}},
    {"number": 68, "name": "Ccca", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}]}},
    {"number": 69, "name": "Fmmm", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "parity", "rule": "all_even"}, {"type": "parity", "rule": "all_odd"}]}},
    {"number": 70, "name": "Fddd", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "parity", "rule": "all_even"}, {"type": "parity", "rule": "all_odd"}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k+l", "divisor": 4}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "h+l", "divisor": 4}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h+k", "divisor": 4}]}]}},
    {"number": 71, "name": "Immm", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"type": "expression_check", "expression": "h+k+l", "divisor": 2}},
    {"number": 72, "name": "Ibam", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}]}},
    {"number": 73, "name": "Ibca", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 74, "name": "Imma", "system": "orthorhombic", "laue_class": "mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k+l", "divisor": 2}]}]}},
    {"number": 75, "name": "P4", "system": "tetragonal", "laue_class": "4/m", "rule_tree": {}},
    {"number": 76, "name": "P41", "system": "tetragonal", "laue_class": "4/m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 4}]}},
    {"number": 77, "name": "P42", "system": "tetragonal", "laue_class": "4/m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 78, "name": "P43", "system": "tetragonal", "laue_class": "4/m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 4}]}},
    {"number": 79, "name": "I4", "system": "tetragonal", "laue_class": "4/m", "rule_tree": {"type": "expression_check", "expression": "h+k+l", "divisor": 2}},
    {"number": 80, "name": "I41", "system": "tetragonal", "laue_class": "4/m", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 4}]}]}},
    {"number": 81, "name": "P-4", "system": "tetragonal", "laue_class": "4/m", "rule_tree": {}},
    {"number": 82, "name": "I-4", "system": "tetragonal", "laue_class": "4/m", "rule_tree": {"type": "expression_check", "expression": "h+k+l", "divisor": 2}},
    {"number": 83, "name": "P4/m", "system": "tetragonal", "laue_class": "4/m", "rule_tree": {}},
    {"number": 84, "name": "P42/m", "system": "tetragonal", "laue_class": "4/m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 85, "name": "P4/n", "system": "tetragonal", "laue_class": "4/m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h+k", "divisor": 2}]}},
    {"number": 86, "name": "P42/n", "system": "tetragonal", "laue_class": "4/m", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h+k", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 87, "name": "I4/m", "system": "tetragonal", "laue_class": "4/m", "rule_tree": {"type": "expression_check", "expression": "h+k+l", "divisor": 2}},
    {"number": 88, "name": "I41/a", "system": "tetragonal", "laue_class": "4/m", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 4}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "hhl", "inverse": true}, {"type": "expression_check", "expression": "2h+l", "divisor": 4}]}]}},
    {"number": 89, "name": "P422", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 90, "name": "P4212", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}},
    {"number": 91, "name": "P4122", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 4}]}},
    {"number": 92, "name": "P41212", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 4}]}]}},
    {"number": 93, "name": "P4222", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 94, "name": "P42212", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}},
    {"number": 95, "name": "P4322", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 4}]}},
    {"number": 96, "name": "P43212", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 4}]}]}},
    {"number": 97, "name": "I422", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"type": "expression_check", "expression": "h+k+l", "divisor": 2}},
    {"number": 98, "name": "I4122", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 4}]}]}},
    {"number": 99, "name": "P4mm", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {}},
    {"number": 100, "name": "P4bm", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}},
    {"number": 101, "name": "P42cm", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}},
    {"number": 102, "name": "P42nm", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h+k", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}]}},
    {"number": 103, "name": "P4cc", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 104, "name": "P4nc", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h+k", "divisor": 2}]}},
    {"number": 105, "name": "P42mc", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0k0", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}]}},
    {"number": 106, "name": "P42bc", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 107, "name": "I4mm", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"type": "expression_check", "expression": "h+k+l", "divisor": 2}},
    {"number": 108, "name": "I4cm", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}]}},
    {"number": 109, "name": "I41md", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "hhl", "inverse": true}, {"type": "expression_check", "expression": "2h+l", "divisor": 4}]}]}},
    {"number": 110, "name": "I41cd", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "hhl", "inverse": true}, {"type": "expression_check", "expression": "2h+l", "divisor": 4}]}]}},
    {"number": 111, "name": "P-42m", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "0k0", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}},
    {"number": 112, "name": "P-42c", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0k0", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}]}},
    {"number": 113, "name": "P-421m", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {}},
    {"number": 114, "name": "P-421c", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 115, "name": "P-4m2", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {}},
    {"number": 116, "name": "P-4c2", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 117, "name": "P-4b2", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}},
    {"number": 118, "name": "P-4n2", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h+k", "divisor": 2}]}},
    {"number": 119, "name": "I-4m2", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"type": "expression_check", "expression": "h+k+l", "divisor": 2}},
    {"number": 120, "name": "I-4c2", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 121, "name": "I-42m", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0k0", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}]}},
    {"number": 122, "name": "I-42d", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "hhl", "inverse": true}, {"type": "expression_check", "expression": "2h+l", "divisor": 4}]}]}},
    {"number": 123, "name": "P4/mmm", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {}},
    {"number": 124, "name": "P4/mcc", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 125, "name": "P4/nbm", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h+k", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}]}},
    {"number": 126, "name": "P4/nnc", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h+k", "divisor": 2}]}},
    {"number": 127, "name": "P4/mbm", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}},
    {"number": 128, "name": "P4/mnc", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "h+l", "divisor": 2}]}},
    {"number": 129, "name": "P4/nmm", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h+k", "divisor": 2}]}},
    {"number": 130, "name": "P4/ncc", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h+k", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 131, "name": "P42/mmc", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0k0", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}]}},
    {"number": 132, "name": "P42/mcm", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0k0", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}]}},
    {"number": 133, "name": "P42/nbc", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h+k", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 134, "name": "P42/nnm", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h+k", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "h+l", "divisor": 2}]}]}},
    {"number": 135, "name": "P42/mbc", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 136, "name": "P42/mnm", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h+k", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 137, "name": "P42/nmc", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h+k", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h", "divisor": 2}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}]}},
    {"number": 138, "name": "P42/ncm", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h+k", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "h+l", "divisor": 2}]}]}},
    {"number": 139, "name": "I4/mmm", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"type": "expression_check", "expression": "h+k+l", "divisor": 2}},
    {"number": 140, "name": "I4/mcm", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 141, "name": "I41/amd", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "hhl", "inverse": true}, {"type": "expression_check", "expression": "2h+l", "divisor": 4}]}]}},
    {"number": 142, "name": "I41/acd", "system": "tetragonal", "laue_class": "4/mmm", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"logic": "AND", "rules": [{"type": "expression_check", "expression": "k", "divisor": 2}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "hhl", "inverse": true}, {"type": "expression_check", "expression": "2h+l", "divisor": 4}]}]}},
    {"number": 143, "name": "P3", "system": "trigonal", "laue_class": "-3", "rule_tree": {}},
    {"number": 144, "name": "P31", "system": "trigonal", "laue_class": "-3", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 3}]}},
    {"number": 145, "name": "P32", "system": "trigonal", "laue_class": "-3", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 3}]}},
    {"number": 146, "name": "R3", "system": "trigonal", "laue_class": "-3", "rule_tree": {"type": "expression_check", "expression": "-h+k+l", "divisor": 3}},
    {"number": 147, "name": "P-3", "system": "trigonal", "laue_class": "-3", "rule_tree": {}},
    {"number": 148, "name": "R-3", "system": "trigonal", "laue_class": "-3", "rule_tree": {"type": "expression_check", "expression": "-h+k+l", "divisor": 3}},
    {"number": 149, "name": "P312", "system": "trigonal", "laue_class": "-3m", "rule_tree": {}},
    {"number": 150, "name": "P321", "system": "trigonal", "laue_class": "-3m", "rule_tree": {}},
    {"number": 151, "name": "P3112", "system": "trigonal", "laue_class": "-3m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 3}]}},
    {"number": 152, "name": "P3121", "system": "trigonal", "laue_class": "-3m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 3}]}},
    {"number": 153, "name": "P3212", "system": "trigonal", "laue_class": "-3m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 3}]}},
    {"number": 154, "name": "P3221", "system": "trigonal", "laue_class": "-3m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 3}]}},
    {"number": 155, "name": "R32", "system": "trigonal", "laue_class": "-3m", "rule_tree": {"type": "expression_check", "expression": "-h+k+l", "divisor": 3}},
    {"number": 156, "name": "P3m1", "system": "trigonal", "laue_class": "-3m", "rule_tree": {}},
    {"number": 157, "name": "P31m", "system": "trigonal", "laue_class": "-3m", "rule_tree": {}},
    {"number": 158, "name": "P3c1", "system": "trigonal", "laue_class": "-3m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 159, "name": "P31c", "system": "trigonal", "laue_class": "-3m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 160, "name": "R3m", "system": "trigonal", "laue_class": "-3m", "rule_tree": {"type": "expression_check", "expression": "-h+k+l", "divisor": 3}},
    {"number": 161, "name": "R3c", "system": "trigonal", "laue_class": "-3m", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "-h+k+l", "divisor": 3}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 162, "name": "P-31m", "system": "trigonal", "laue_class": "-3m", "rule_tree": {}},
    {"number": 163, "name": "P-31c", "system": "trigonal", "laue_class": "-3m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 164, "name": "P-3m1", "system": "trigonal", "laue_class": "-3m", "rule_tree": {}},
    {"number": 165, "name": "P-3c1", "system": "trigonal", "laue_class": "-3m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 166, "name": "R-3m", "system": "trigonal", "laue_class": "-3m", "rule_tree": {"type": "expression_check", "expression": "-h+k+l", "divisor": 3}},
    {"number": 167, "name": "R-3c", "system": "trigonal", "laue_class": "-3m", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "-h+k+l", "divisor": 3}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 168, "name": "P6", "system": "hexagonal", "laue_class": "6/m", "rule_tree": {}},
    {"number": 169, "name": "P61", "system": "hexagonal", "laue_class": "6/m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 6}]}},
    {"number": 170, "name": "P65", "system": "hexagonal", "laue_class": "6/m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 6}]}},
    {"number": 171, "name": "P62", "system": "hexagonal", "laue_class": "6/m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 3}]}},
    {"number": 172, "name": "P64", "system": "hexagonal", "laue_class": "6/m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 3}]}},
    {"number": 173, "name": "P63", "system": "hexagonal", "laue_class": "6/m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 174, "name": "P-6", "system": "hexagonal", "laue_class": "6/m", "rule_tree": {}},
    {"number": 175, "name": "P6/m", "system": "hexagonal", "laue_class": "6/m", "rule_tree": {}},
    {"number": 176, "name": "P63/m", "system": "hexagonal", "laue_class": "6/m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 177, "name": "P622", "system": "hexagonal", "laue_class": "6/mmm", "rule_tree": {}},
    {"number": 178, "name": "P6122", "system": "hexagonal", "laue_class": "6/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 6}]}},
    {"number": 179, "name": "P6522", "system": "hexagonal", "laue_class": "6/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 6}]}},
    {"number": 180, "name": "P6222", "system": "hexagonal", "laue_class": "6/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 3}]}},
    {"number": 181, "name": "P6422", "system": "hexagonal", "laue_class": "6/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 3}]}},
    {"number": 182, "name": "P6322", "system": "hexagonal", "laue_class": "6/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 183, "name": "P6mm", "system": "hexagonal", "laue_class": "6/mmm", "rule_tree": {}},
    {"number": 184, "name": "P6cc", "system": "hexagonal", "laue_class": "6/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 185, "name": "P63cm", "system": "hexagonal", "laue_class": "6/mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 186, "name": "P63mc", "system": "hexagonal", "laue_class": "6/mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 187, "name": "P-6m2", "system": "hexagonal", "laue_class": "6/mmm", "rule_tree": {}},
    {"number": 188, "name": "P-6c2", "system": "hexagonal", "laue_class": "6/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 189, "name": "P-62m", "system": "hexagonal", "laue_class": "6/mmm", "rule_tree": {}},
    {"number": 190, "name": "P-62c", "system": "hexagonal", "laue_class": "6/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 191, "name": "P6/mmm", "system": "hexagonal", "laue_class": "6/mmm", "rule_tree": {}},
    {"number": 192, "name": "P6/mcc", "system": "hexagonal", "laue_class": "6/mmm", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}},
    {"number": 193, "name": "P63/mcm", "system": "hexagonal", "laue_class": "6/mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 194, "name": "P63/mmc", "system": "hexagonal", "laue_class": "6/mmm", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "h0l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "00l", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 195, "name": "P23", "system": "cubic", "laue_class": "m-3", "rule_tree": {}},
    {"number": 196, "name": "F23", "system": "cubic", "laue_class": "m-3", "rule_tree": {"logic": "OR", "rules": [{"type": "parity", "rule": "all_even"}, {"type": "parity", "rule": "all_odd"}]}},
    {"number": 197, "name": "I23", "system": "cubic", "laue_class": "m-3", "rule_tree": {"type": "expression_check", "expression": "h+k+l", "divisor": 2}},
    {"number": 198, "name": "P213", "system": "cubic", "laue_class": "m-3", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}},
    {"number": 199, "name": "I213", "system": "cubic", "laue_class": "m-3", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}]}},
    {"number": 200, "name": "Pm-3", "system": "cubic", "laue_class": "m-3", "rule_tree": {}},
    {"number": 201, "name": "Pn-3", "system": "cubic", "laue_class": "m-3", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "hkl", "inverse": true}, {"type": "expression_check", "expression": "k+l", "divisor": 2}]}},
    {"number": 202, "name": "Fm-3", "system": "cubic", "laue_class": "m-3", "rule_tree": {"logic": "OR", "rules": [{"type": "parity", "rule": "all_even"}, {"type": "parity", "rule": "all_odd"}]}},
    {"number": 203, "name": "Fd-3", "system": "cubic", "laue_class": "m-3", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "parity", "rule": "all_even"}, {"type": "parity", "rule": "all_odd"}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k+l", "divisor": 4}]}]}},
    {"number": 204, "name": "Im-3", "system": "cubic", "laue_class": "m-3", "rule_tree": {"type": "expression_check", "expression": "h+k+l", "divisor": 2}},
    {"number": 205, "name": "Pa-3", "system": "cubic", "laue_class": "m-3", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}},
    {"number": 206, "name": "Ia-3", "system": "cubic", "laue_class": "m-3", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"logic": "AND", "rules": [{"type": "expression_check", "expression": "k", "divisor": 2}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}]}},
    {"number": 207, "name": "P432", "system": "cubic", "laue_class": "m-3m", "rule_tree": {}},
    {"number": 208, "name": "P4232", "system": "cubic", "laue_class": "m-3m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 2}]}},
    {"number": 209, "name": "F432", "system": "cubic", "laue_class": "m-3m", "rule_tree": {"logic": "OR", "rules": [{"type": "parity", "rule": "all_even"}, {"type": "parity", "rule": "all_odd"}]}},
    {"number": 210, "name": "F4132", "system": "cubic", "laue_class": "m-3m", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "parity", "rule": "all_even"}, {"type": "parity", "rule": "all_odd"}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 4}]}]}},
    {"number": 211, "name": "I432", "system": "cubic", "laue_class": "m-3m", "rule_tree": {"type": "expression_check", "expression": "h+k+l", "divisor": 2}},
    {"number": 212, "name": "P4332", "system": "cubic", "laue_class": "m-3m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 4}]}},
    {"number": 213, "name": "P4132", "system": "cubic", "laue_class": "m-3m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 4}]}},
    {"number": 214, "name": "I4132", "system": "cubic", "laue_class": "m-3m", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "h00", "inverse": true}, {"type": "expression_check", "expression": "h", "divisor": 4}]}]}},
    {"number": 215, "name": "P-43m", "system": "cubic", "laue_class": "m-3m", "rule_tree": {}},
    {"number": 216, "name": "F-43m", "system": "cubic", "laue_class": "m-3m", "rule_tree": {"logic": "OR", "rules": [{"type": "parity", "rule": "all_even"}, {"type": "parity", "rule": "all_odd"}]}},
    {"number": 217, "name": "I-43m", "system": "cubic", "laue_class": "m-3m", "rule_tree": {"type": "expression_check", "expression": "h+k+l", "divisor": 2}},
    {"number": 218, "name": "P-43n", "system": "cubic", "laue_class": "m-3m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "hhl", "inverse": true}, {"type": "expression_check", "expression": "h+l", "divisor": 2}]}},
    {"number": 219, "name": "F-43c", "system": "cubic", "laue_class": "m-3m", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "parity", "rule": "all_even"}, {"type": "parity", "rule": "all_odd"}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "hhl", "inverse": true}, {"type": "expression_check", "expression": "h+l", "divisor": 2}]}]}},
    {"number": 220, "name": "I-43d", "system": "cubic", "laue_class": "m-3m", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "hhl", "inverse": true}, {"type": "expression_check", "expression": "2h+l", "divisor": 4}]}]}},
    {"number": 221, "name": "Pm-3m", "system": "cubic", "laue_class": "m-3m", "rule_tree": {}},
    {"number": 222, "name": "Pn-3n", "system": "cubic", "laue_class": "m-3m", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k+l", "divisor": 2}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "hhl", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 223, "name": "Pm-3n", "system": "cubic", "laue_class": "m-3m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "hk0", "inverse": true}, {"type": "expression_check", "expression": "h+k", "divisor": 2}]}},
    {"number": 224, "name": "Pn-3m", "system": "cubic", "laue_class": "m-3m", "rule_tree": {"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k+l", "divisor": 2}]}},
    {"number": 225, "name": "Fm-3m", "system": "cubic", "laue_class": "m-3m", "rule_tree": {"logic": "OR", "rules": [{"type": "parity", "rule": "all_even"}, {"type": "parity", "rule": "all_odd"}]}},
    {"number": 226, "name": "Fm-3c", "system": "cubic", "laue_class": "m-3m", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "parity", "rule": "all_even"}, {"type": "parity", "rule": "all_odd"}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "hhl", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 227, "name": "Fd-3m", "system": "cubic", "laue_class": "m-3m", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "parity", "rule": "all_even"}, {"type": "parity", "rule": "all_odd"}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k+l", "divisor": 4}]}]}},
    {"number": 228, "name": "Fd-3c", "system": "cubic", "laue_class": "m-3m", "rule_tree": {"logic": "AND", "rules": [{"logic": "OR", "rules": [{"type": "parity", "rule": "all_even"}, {"type": "parity", "rule": "all_odd"}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"type": "expression_check", "expression": "k+l", "divisor": 4}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "hhl", "inverse": true}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}},
    {"number": 229, "name": "Im-3m", "system": "cubic", "laue_class": "m-3m", "rule_tree": {"type": "expression_check", "expression": "h+k+l", "divisor": 2}},
    {"number": 230, "name": "Ia-3d", "system": "cubic", "laue_class": "m-3m", "rule_tree": {"logic": "AND", "rules": [{"type": "expression_check", "expression": "h+k+l", "divisor": 2}, {"logic": "OR", "rules": [{"type": "family_check", "family": "0kl", "inverse": true}, {"logic": "AND", "rules": [{"type": "expression_check", "expression": "k", "divisor": 2}, {"type": "expression_check", "expression": "l", "divisor": 2}]}]}, {"logic": "OR", "rules": [{"type": "family_check", "family": "hhl", "inverse": true}, {"type": "expression_check", "expression": "2h+l", "divisor": 4}]}]}}
    ];

    // --- Core Logic Functions ---
    const getSystemAndCentering = () => {
        let [system, centering] = controls.bravaisLattice.value.split('_');
        if (system === "rhombohedral") centering = "R";
        return { system, centering };
    };
    
    const getAllParams = () => {
        let params = {
            lambda: parseFloat(controls.wavelength.value),
            lambda2: parseFloat(controls.wavelength2.value),
            ratio: parseFloat(controls.ratio21.value),
            zeroShift: parseFloat(controls.zeroShift.value)
        };
        document.querySelectorAll('#lattice-parameters-container input[type="number"]').forEach(input => {
            const paramName = input.id.replace('lattice-param-', '');
            params[paramName] = parseFloat(input.value);
        });
        const { system } = getSystemAndCentering();
        switch(system) {
            case 'cubic': case 'tetragonal': case 'orthorhombic': 
                params.alpha = params.beta = params.gamma = 90; break;
            case 'rhombohedral': case 'hexagonal': 
                params.alpha = params.beta = 90; params.gamma = 120; break;
            case 'monoclinic': 
                params.alpha = params.gamma = 90; break;
        }
        return params;
    };

    function updateLatticeParamUI() {
        const currentValues = {};
        const container = controls.latticeParamsContainer;
        container.querySelectorAll('input[type="number"]').forEach(input => {
            currentValues[input.id.replace('lattice-param-', '')] = input.value;
        });
        const { system } = getSystemAndCentering();
        container.innerHTML = '';
        const createInput = (name, label, defaultValue, step, isAngle = false) => {
            const valueToUse = currentValues[name] !== undefined ? currentValues[name] : defaultValue;
            const unit = isAngle ? '°' : 'Å';
            const row = document.createElement('div');
            row.className = 'parameter-grid';
            row.innerHTML = `<label for="lattice-param-${name}" class="control-label">${label} (${unit})</label>
                             <input type="number" id="lattice-param-${name}" value="${valueToUse}" step="${step}" class="control-input" ${isAngle ? '' : 'min="0.001"'}>`;
            container.appendChild(row);
        };
        const params = {
            cubic: [{ name: 'a', label: 'a', value: 4.23, step: 0.001 }],
            tetragonal: [{ name: 'a', label: 'a', value: 4.0, step: 0.001 }, { name: 'c', label: 'c', value: 5.0, step: 0.001 }],
            orthorhombic: [{ name: 'a', label: 'a', value: 4.0, step: 0.001 }, { name: 'b', label: 'b', value: 5.0, step: 0.001 }, { name: 'c', label: 'c', value: 6.0, step: 0.001 }],
            hexagonal: [{ name: 'a', label: 'a', value: 4.0, step: 0.001 }, { name: 'c', label: 'c', value: 6.0, step: 0.001 }],
            rhombohedral: [{ name: 'a', label: 'a', value: 5.5, step: 0.001 }, { name: 'c', label: 'c', value: 15.0, step: 0.001 }],
            monoclinic: [{ name: 'a', label: 'a', value: 4.0, step: 0.001 }, { name: 'b', label: 'b', value: 5.0, step: 0.001 }, { name: 'c', label: 'c', value: 6.0, step: 0.001 }, { name: 'beta', label: 'β', value: 105.0, step: 0.01, isAngle: true }]
        };
        if(params[system]) params[system].forEach(p => createInput(p.name, p.label, p.value, p.step, p.isAngle));
    }

    function updateSpaceGroupUI() {
        const { system } = getSystemAndCentering();
        const filteredGroups = spaceGroups.filter(sg => {
            if (system === 'rhombohedral') return sg.system === 'hexagonal' && sg.name.startsWith('R');
            const selectedCentering = controls.bravaisLattice.value.split('_')[1];
            return sg.system === system && sg.name.charAt(0).toUpperCase() === selectedCentering;
        });
        controls.spaceGroupSelect.innerHTML = "";
        filteredGroups.forEach(sg => {
            const opt = document.createElement("option");
            opt.value = sg.number;
            opt.textContent = `${sg.number} – ${sg.name}`;
            controls.spaceGroupSelect.appendChild(opt);
        });
    }

    function updateUIForSystemChange() {
        updateLatticeParamUI();
        updateSpaceGroupUI();
        if (fullExperimentalData.tth.length > 0) {
            generateMasterHklList();
        }
    }
    
    // --- File Parsing (Unchanged) ---
    const detectAndParseFile=(n,e)=>{const t=n.toLowerCase(),i=e.trim().split(/\r?\n/),l=i.length>0?i[0].trim():"";if(t.endsWith(".uxd")||l.startsWith("_FILEVERSION"))return parseUxdFile(e);if(t.endsWith(".xrdml")||e.includes("<?xml")&&e.includes("<xrdMeasurement"))return parseXrdmlFile(e);if(t.endsWith(".brml")||e.includes("<?xml")&&e.includes("<RawDataFile"))return parseBrukerBrmlFile(e);if(t.endsWith(".ras")||e.toUpperCase().includes("*RAS_HEADER_START"))return parseRigakuRasFile(e);if(t.endsWith(".udf"))return parsePhilipsUdfFile(e);const a=i.find(n=>n.trim().toUpperCase().startsWith("BANK"));return a?a.toUpperCase().includes("STD")?parseGsasXraFile(e):parseGsasEsdFile(e):parseDataFile(e)},parseDataFile=n=>{const e=[],t=[];return n.trim().split(/\r?\n/).forEach(n=>{if(n.startsWith("#")||n.startsWith("//")||""===n.trim())return;const i=n.trim().split(/[\s,;]+/);if(i.length>=2){const n=parseFloat(i[0]),l=parseFloat(i[1]);isNaN(n)||isNaN(l)||(e.push(n),t.push(l))}}),{tth:e,intensity:t}},parseXrdmlFile=n=>{const e=new DOMParser,t=e.parseFromString(n,"application/xml");if(t.querySelector("parsererror"))throw new Error("Error parsing XRDML file.");let i=null;const l=t.querySelector("kAlpha1");l?.textContent&&(i=parseFloat(l.textContent));const a=t.querySelector("intensities")||t.querySelector("counts");if(!a)throw new Error("Could not find <intensities> or <counts> in XRDML file.");const s=a.textContent.trim().split(/\s+/).map(Number),r=t.querySelector('positions[axis="2Theta"]');if(!r)throw new Error("Could not find <positions> in XRDML file.");const o=r.querySelector("startPosition"),c=r.querySelector("endPosition");if(!o||!c)throw new Error("Could not find start/end positions in XRDML.");const p=parseFloat(o.textContent),m=parseFloat(c.textContent),d=Array.from({length:s.length},(n,e)=>p+e*(m-p)/(s.length-1));return{tth:d,intensity:s,wavelength:i}},parseBrukerBrmlFile=n=>{const e=new DOMParser,t=e.parseFromString(n,"application/xml");if(t.querySelector("parsererror"))throw new Error("Error parsing BRML file.");let i=null;const l=t.querySelector("usedWavelength");if(l){const n=l.getAttribute("kAlpha1");n&&(i=parseFloat(n))}const a=t.querySelector("dataPoints > counts");if(!a)throw new Error("No <counts> data found in BRML file.");const s=a.textContent.trim().split(/\s+/).map(Number),r=t.querySelector('startPosition[axis="TwoTheta"]'),o=t.querySelector('increment[axis="TwoTheta"]');if(!r||!o)throw new Error("Could not find scan parameters in BRML file.");const c=parseFloat(r.textContent),p=parseFloat(o.textContent),m=Array.from({length:s.length},(n,e)=>c+e*p);return{tth:m,intensity:s,wavelength:i}},parseRigakuRasFile=n=>{const e=[],t=[];let i=!1,l=null;for(const a of n.trim().split(/\r?\n/)){const n=a.toUpperCase();if(n.startsWith("*WAVE_LENGTH")||n.startsWith("*MEAS_COND_XG_WAVE_LENGTH")){const e=a.trim().split(/\s+/);if(e.length>1){const n=parseFloat(e[1]);isNaN(n)||(l=n)}}if(n.startsWith("*RAS_INT_START")){i=!0;continue}if(n.startsWith("*RAS_INT_END"))break;if(i){const n=a.trim().split(/[\s,]+/);if(n.length>=2){const i=parseFloat(n[0]),l=parseFloat(n[1]);isNaN(i)||isNaN(l)||(e.push(i),t.push(l))}}}if(0===e.length)throw new Error("No data found in RAS file data section.");return{tth:e,intensity:t,wavelength:l}},parseGsasEsdFile=n=>{const e=n.trim().split(/\r?\n/);let t,i,l,a=-1;if(e.forEach((n,s)=>{const r=n.toUpperCase();if(r.includes("WAVELENGTH")){const e=n.match(/wavelength\s+([0-9.]+)/i);e&&e[1]&&(t=parseFloat(e[1]))}if(r.startsWith("BANK")){const e=n.trim().split(/\s+/);e.length>=6&&"CONST"===e[4].toUpperCase()&&(i=parseFloat(e[5])/100,l=parseFloat(e[6])/100,a=s+1)}}),void 0===i||void 0===l)throw new Error("GSAS Parse Error: Could not find a valid 'BANK' line with CONST scan parameters.");if(-1!==a&&e[a]?.toUpperCase().includes("STD"))a++;if(-1===a||a>=e.length)throw new Error("GSAS Parse Error: Found scan parameters but no subsequent data lines.");const s=[];for(let n=a;n<e.length;n++){const t=e[n].trim().split(/\s+/);for(let n=1;n<t.length;n+=2){const e=parseFloat(t[n]);isNaN(e)||s.push(e)}}if(0===s.length)throw new Error("GSAS Parse Error: No intensity data could be parsed.");const r=Array.from({length:s.length},(n,e)=>i+e*l);return{tth:r,intensity:s,wavelength:t}},parseGsasXraFile=n=>{const e=n.trim().split(/\r?\n/);let t,i,l,a=-1;if(e.forEach((n,s)=>{const r=n.toUpperCase();if(r.includes("WAVELENGTH")){const e=n.match(/wavelength\s+([0-9.]+)/i);e&&e[1]&&(t=parseFloat(e[1]))}if(r.startsWith("BANK")){const e=n.trim().split(/\s+/);e.length>=7&&"CONST"===e[4].toUpperCase()&&(i=parseFloat(e[5])/100,l=parseFloat(e[6])/100,a=s+1)}}),void 0===i||void 0===l)throw new Error("GSAS XRA Parse Error: Could not find a valid 'BANK' line with CONST scan parameters.");if(-1===a||a>=e.length)throw new Error("GSAS XRA Parse Error: Found scan parameters but no subsequent data lines.");const s=[];for(let n=a;n<e.length;n++){if(""===e[n].trim())continue;const t=e[n].trim().split(/\s+/);for(let n=0;n<t.length;n++){const e=parseFloat(t[n]);isNaN(e)||s.push(e)}}if(0===s.length)throw new Error("GSAS XRA Parse Error: No intensity data could be parsed.");const r=Array.from({length:s.length},(n,e)=>i+e*l);return{tth:r,intensity:s,wavelength:t}},parseUxdFile=n=>{const e=n.trim().split(/\r?\n/),t=[];let i,l,a,s=!1;for(const r of e){const e=r.trim();s?e.split(/\s+/).forEach(n=>{const e=parseFloat(n);isNaN(e)||t.push(e)}):e.toUpperCase().startsWith("_START=")?i=parseFloat(e.substring(7)):e.toUpperCase().startsWith("_STEPSIZE=")?l=parseFloat(e.substring(10)):e.toUpperCase().startsWith("_WL1=")?a=parseFloat(e.substring(5)):"_COUNTS"===e.toUpperCase()&&(s=!0)}if(void 0===i||void 0===l)throw new Error("Could not find _START and _STEPSIZE in UXD file.");if(0===t.length)throw new Error("No intensity data found after _COUNTS in UXD file.");const r=Array.from({length:t.length},(n,e)=>i+e*l);return{tth:r,intensity:t,wavelength:a}},parsePhilipsUdfFile=n=>{const e=n.trim().split(/\r?\n/),t=[],i=[];let l,a=!1;for(const s of e){const e=s.trim();if(e.toUpperCase().startsWith("LAMBDA")){const n=e.split("=");n.length>1&&(l=parseFloat(n[1]))}if("[DATA]"===e.toUpperCase()){a=!0;continue}e.startsWith("[")&&"[DATA]"!==e.toUpperCase()&&(a=!1),a&&e.split(/,/).map(n=>n.trim()).length>=2&&(n=parseFloat(e[0]),s=parseFloat(e[1]),isNaN(n)||isNaN(s)||(t.push(n),i.push(s)))}if(0===t.length)throw new Error("No [Data] section found in UDF file.");return{tth:t,intensity:i,wavelength:l}};

    // --- Simulation Logic ---
    function calculateRollingBallBackground(intensity_sqrt, windowPoints) {
        if (intensity_sqrt.length === 0) return [];
        const background = new Array(intensity_sqrt.length);
        const halfWindow = Math.floor(windowPoints / 2);
        for (let i = 0; i < intensity_sqrt.length; i++) {
            const start = Math.max(0, i - halfWindow);
            const end = Math.min(intensity_sqrt.length, i + halfWindow + 1);
            let min = Infinity;
            for (let j = start; j < end; j++) {
                if (intensity_sqrt[j] < min) min = intensity_sqrt[j];
            }
            background[i] = min;
        }
        return background;
    }

    function findExperimentalPeaks(tth, intensity, intensity_sqrt, thresholdPercent, windowPoints) {
        if (intensity_sqrt.length < (2 * windowPoints + 1)) return [];
        const peaks = [];
        const maxIntensity = Math.max(...intensity_sqrt);
        const threshold = (thresholdPercent / 100) * maxIntensity;
        for (let i = windowPoints; i < intensity_sqrt.length - windowPoints; i++) {
            const currentIntensity = intensity_sqrt[i];
            if (currentIntensity < threshold) continue;
            let isPeak = true;
            for (let j = 1; j <= windowPoints; j++) {
                if (intensity_sqrt[i - j] >= currentIntensity || intensity_sqrt[i + j] >= currentIntensity) {
                    isPeak = false;
                    break;
                }
            }
            if (isPeak) {
                peaks.push({ tth: tth[i], intensity: intensity[i], index: i });
                i += windowPoints;
            }
        }
        return peaks;
    }

    function isReflectionAllowed(h, k, l, spaceGroupData) {
        const ruleNode = spaceGroupData.rule_tree;
        if (!ruleNode || Object.keys(ruleNode).length === 0) return true;
        const evaluateExpression = (expr, h, k, l) => {
            switch (expr.trim()) {
                case 'h+k': return h + k; case 'k+l': return k + l; case 'h+l': return h + l;
                case 'h+k+l': return h + k + l; case '-h+k+l': return -h + k + l; case '2h+l': return 2 * h + l;
                case 'h': return h; case 'k': return k; case 'l': return l; default: return NaN;
            }
        };
        const evaluateNode = (node) => {
            if (node.type) {
                if (node.type === "family_check") {
                    let match = false;
                    if (node.family === '0kl' && h === 0 && k !== 0 && l !== 0) match = true;
                    else if (node.family === 'h0l' && k === 0 && h !== 0 && l !== 0) match = true;
                    else if (node.family === 'hk0' && l === 0 && h !== 0 && k !== 0) match = true;
                    else if (node.family === 'h00' && k === 0 && l === 0 && h !== 0) match = true;
                    else if (node.family === '0k0' && h === 0 && l === 0 && k !== 0) match = true;
                    else if (node.family === '00l' && h === 0 && k === 0 && l !== 0) match = true;
                    else if (node.family === 'hhl' && h === k && h !== 0 && l !== 0) match = true;
                    return node.inverse ? !match : match;
                }
                if (node.type === "parity") {
                    const isAllEven = h % 2 === 0 && k % 2 === 0 && l % 2 === 0;
                    const isAllOdd = h % 2 !== 0 && k % 2 !== 0 && l % 2 !== 0;
                    if (node.rule === "all_even") return isAllEven;
                    if (node.rule === "all_odd") return isAllOdd;
                }
                if (node.type === "expression_check") {
                    const value = evaluateExpression(node.expression, h, k, l);
                    return !isNaN(value) && value % node.divisor === 0;
                } return true;
            }
            if (node.logic === "AND") return node.rules.every(subNode => evaluateNode(subNode));
            if (node.logic === "OR") return node.rules.some(subNode => evaluateNode(subNode));
            return true;
        }; return evaluateNode(ruleNode);
    }
    
    function getMultiplicityAndCanonicalHKL(h, k, l, laue_class) {
        if (h === 0 && k === 0 && l === 0) return { multiplicity: 1 };
        let m = 0;
        switch (laue_class) {
            case 'm-3m': if (h > k && k > l && l > 0) m = 48; else if (h === k && k > l && l > 0) m = 24; else if (h > k && k === l && l > 0) m = 24; else if (h > k && k > 0 && l === 0) m = 24; else if (h === k && k === l && l > 0) m = 8; else if (h === k && k > 0 && l === 0) m = 12; else if (h > 0 && k === 0 && l === 0) m = 6; break;
            case 'm-3': if (h > k && k > l && l > 0) m = 24; else if (h === k && k > l && l > 0) m = 12; else if (h > k && k === l && l > 0) m = 12; else if (h > k && k > 0 && l === 0) m = 12; else if (h === k && k === l && l > 0) m = 8; else if (h === k && k > 0 && l === 0) m = 6; else if (h > 0 && k === 0 && l === 0) m = 6; break;
            case '6/mmm': if (l > 0) { if (h > k && k > 0) m = 24; else if (h === k && k > 0) m = 12; else if (h > 0 && k === 0) m = 12; else if (h === 0 && k === 0) m = 2; } else { if (h > k && k > 0) m = 12; else if (h === k && k > 0) m = 6; else if (h > 0 && k === 0) m = 6; } break;
            case '6/m': if (l > 0) { if (h > 0 || k > 0) m = 12; else m = 2; } else { if (h > 0 || k > 0) m = 6; } break;
            case '-3m': if (h > k && k > l) m = 12; else if (h === k && k > l) m = 6; else if (h > k && k === l) m = 6; else if (h === k && k === l) m = 2; break;
            case '-3': m = 6; if (h === k && k === l) m = 2; break;
            case '4/mmm': if (l > 0) { if (h > k && k > 0) m = 16; else if (h === k && k > 0) m = 8; else if (h > 0 && k === 0) m = 8; else if (h === 0 && k === 0) m = 2; } else { if (h > k && k > 0) m = 8; else if (h === k && k > 0) m = 4; else if (h > 0 && k === 0) m = 4; } break;
            case '4/m': if (l > 0) { if (h > k && k > 0) m = 8; else if (h === k && k > 0) m = 4; else if (h > 0 && k === 0) m = 8; else if (h === 0 && k === 0) m = 2; } else { if (h > k && k > 0) m = 4; else if (h === k && k > 0) m = 4; else if (h > 0 && k === 0) m = 4; } break;
            case 'mmm': if (h > 0 && k > 0 && l > 0) m = 8; else if ((h > 0 && k > 0 && l === 0) || (h > 0 && k === 0 && l > 0) || (h === 0 && k > 0 && l > 0)) m = 4; else m = 2; break;
            case '2/m': if (k > 0 || l > 0) m = 4; else if (h > 0) m = 2; break;
            case '-1': m = 2; break;
            default: m = 1; break;
        } return { multiplicity: m };
    }

    function generateMasterHklList() {
        if (fullExperimentalData.tth.length === 0 || spaceGroups.length === 0) return;
        const selectedSg = spaceGroups.find(sg => sg.number === parseInt(controls.spaceGroupSelect.value, 10));
        if (!selectedSg) return;
        
        const maxTth = Math.max(...fullExperimentalData.tth) + 2.0;
        const params = getAllParams();
        if (!params.a || !params.lambda || params.a <= 0 || params.lambda <= 0) return;
        
        masterHklList = [];
        updateHklPositions(masterHklList, params, selectedSg, maxTth);
        updateChartWithNewData();
    }

    function updateHklPositions(hklList, params, selectedSg, maxTth) {
        const { a, b, c, alpha, beta, lambda } = params;
        const { system, laue_class } = selectedSg;
        hklList.length = 0;

        const maxDimension = Math.max(a || 0, b || a, c || a);
        const maxIndex = Math.ceil(2 * maxDimension / lambda * Math.sin(maxTth * Math.PI / 360)) + 5;
        let uniqueReflections = [];
        const maxOtherIndex = Math.floor(maxIndex / 1.5);
        const loopAndAdd = (h, k, l) => { if (h === 0 && k === 0 && l === 0) return; if (isReflectionAllowed(h, k, l, selectedSg)) uniqueReflections.push({ h, k, l }); };
        switch (laue_class) {
            case 'm-3m': case 'm-3': for (let l = 0; l < maxIndex; l++) for (let k = l; k < maxIndex; k++) for (let h = k; h < maxIndex; h++) loopAndAdd(h, k, l); break;
            case '6/mmm': case '6/m': for (let l = 0; l < maxIndex; l++) for (let k = 0; k < maxIndex; k++) for (let h = k; h < maxIndex; h++) loopAndAdd(h, k, l); break;
            case '-3m': case '-3': for (let l = -maxOtherIndex; l < maxOtherIndex; l++) for (let k = l; k < maxIndex; k++) for (let h = k; h < maxIndex; h++) loopAndAdd(h, k, l); break;
            case '4/mmm': case '4/m': for (let l = 0; l < maxIndex; l++) for (let k = 0; k < maxIndex; k++) for (let h = k; h < maxIndex; h++) loopAndAdd(h, k, l); break;
            case 'mmm': for (let l = 0; l < maxIndex; l++) for (let k = 0; k < maxIndex; k++) for (let h = 0; h < maxIndex; h++) loopAndAdd(h, k, l); break;
            case '2/m': for (let k = 0; k < maxIndex; k++) for (let l = 0; l < maxIndex; l++) for (let h = -maxOtherIndex; h < maxIndex; h++) if (!((k === 0 && h < 0) || (l === 0 && h < 0))) loopAndAdd(h, k, l); break;
            case '-1': for (let k = 0; k < maxIndex; k++) for (let h = -maxOtherIndex; h < maxIndex; h++) for (let l = -maxOtherIndex; l < maxIndex; l++) if (!(k > 0 || l < 0)) loopAndAdd(h, k, l); break;
            default: for (let h = 0; h < maxIndex; h++) for (let k = 0; k < maxIndex; k++) for (let l = 0; l < maxIndex; l++) loopAndAdd(h, k, l); break;
        }

        const deg2rad = Math.PI / 180; const beta_rad = (beta || 90) * deg2rad;
        for (const { h, k, l } of uniqueReflections) {
            let inv_d_sq = 0;
            switch (system) {
                case 'cubic': inv_d_sq = (h * h + k * k + l * l) / (a * a); break;
                case 'tetragonal': inv_d_sq = (h * h + k * k) / (a * a) + (l * l) / ((c || a) * (c || a)); break;
                case 'orthorhombic': inv_d_sq = (h * h) / (a * a) + (k * k) / ((b || a) * (b || a)) + (l * l) / ((c || a) * (c || a)); break;
                case 'hexagonal': case 'rhombohedral': inv_d_sq = 4 * (h * h + h * k + k * k) / (3 * a * a) + (l * l) / ((c || a) * (c || a)); break;
                case 'monoclinic': const sin_beta = Math.sin(beta_rad); inv_d_sq = (1 / (sin_beta * sin_beta)) * ((h * h) / (a * a) + (k * k * sin_beta * sin_beta) / ((b||a)*(b||a)) + (l * l) / ((c||a)*(c||a)) - (2 * h * l * Math.cos(beta_rad)) / (a * (c||a))); break;
            }
            if (inv_d_sq <= 1e-12) continue;
            const sinThetaSq = (lambda * lambda / 4) * inv_d_sq;
            if (sinThetaSq > 1 || sinThetaSq <= 0) continue;
            const tth = 2 * Math.asin(Math.sqrt(sinThetaSq)) / deg2rad;
            if (tth > maxTth) continue;
            const { multiplicity } = getMultiplicityAndCanonicalHKL(h, k, l, laue_class);
            hklList.push({ tth, hkl_list: [`(${h},${k},${l})`], multiplicity });
        }
        hklList.sort((a, b) => a.tth - b.tth);
    }
    
    // --- Charting ---
    function initializeChart() {
        if (mainChart) mainChart.destroy();
        const yMax = Math.max(...fullExperimentalData.intensity_sqrt) || 1000;
        mainChart = new Chart(controls.mainChartCanvas, {
            type: 'line',
            data: { datasets: [
                { label: 'Experimental', data: [], borderColor: 'rgba(107, 114, 128, 0.7)', borderWidth: 1, pointRadius: 0, order: 3 },
                { label: 'Background', data: [], borderColor: 'rgba(217, 119, 6, 0.8)', borderWidth: 1.5, pointRadius: 0, borderDash: [5, 5], order: 2 },
                { type: 'bar', label: 'Experimental Peaks', data: [], backgroundColor: 'rgba(239, 68, 68, 0.8)', barThickness: 1, order: 1 },
                { type: 'bar', label: 'Calculated HKLs', data: [], backgroundColor: 'rgba(59, 130, 246, 0.9)', barThickness: 1, order: 0 }
            ]},
            options: {
                responsive: true, maintainAspectRatio: false, animation: false,
                scales: {
                    x: { type: 'linear', title: { display: true, text: '2θ (degrees)', font: { size: 14 }}},
                    y: { type: 'linear', title: { display: true, text: 'Intensity (a.u.)¹/²', font: { size: 14 }}, min: -yMax * 0.3, max: yMax * 1.1 }
                },
                plugins: {
                    zoom: { 
                        pan: { enabled: true, mode: 'xy', onPanComplete: repositionMarkersAndUpdate }, 
                        zoom: { wheel: { enabled: false }, onZoomComplete: repositionMarkersAndUpdate } 
                    },
                    legend: { position: 'top' },
                    tooltip: { 
                        enabled: true, mode: 'nearest', intersect: false,
                        filter: (item) => item.dataset.type === 'bar',
                        backgroundColor: (context) => {
                            if (!context.tooltipItems.length) return Chart.defaults.plugins.tooltip.backgroundColor;
                            const label = context.tooltipItems[0].dataset.label;
                            return label === 'Experimental Peaks' ? 'rgba(239, 68, 68, 0.9)' : 'rgba(59, 130, 246, 0.9)';
                        },
                        callbacks: {
                            title: (items) => items.length ? items[0].raw.tooltip : '',
                            label: () => null
                        }
                    }
                }
            }
        });
        mainChart.options.globalYMax = yMax;
    }

    function repositionMarkersAndUpdate() {
        if (mainChart) {
            const expData = mainChart.data.datasets.find(d => d.label === 'Experimental Peaks').data;
            const calcData = mainChart.data.datasets.find(d => d.label === 'Calculated HKLs').data;
            repositionMarkers(expData, calcData);
            mainChart.update('none');
        }
    }
    
    function updateChartWithNewData() {
        if (!mainChart || fullExperimentalData.tth.length === 0) return;
        
        const findDataset = (label) => mainChart.data.datasets.find(d => d.label === label);
        const params = getAllParams();
        
        findDataset('Experimental').data = fullExperimentalData.tth.map((t, i) => ({ x: t, y: fullExperimentalData.intensity_sqrt[i] }));
        const background_sqrt = calculateRollingBallBackground(fullExperimentalData.intensity_sqrt, parseInt(controls.rollingBallWindow.value));
        findDataset('Background').data = fullExperimentalData.tth.map((t, i) => ({ x: t, y: background_sqrt[i] }));
        
        const expPeaks = findExperimentalPeaks(fullExperimentalData.tth, fullExperimentalData.intensity, fullExperimentalData.intensity_sqrt, parseFloat(controls.peakThreshold.value), 5);
        const expPeakData = expPeaks.map(peak => {
            const dSpacing = params.lambda / (2 * Math.sin(peak.tth * Math.PI / 360));
            return { x: peak.tth, tooltip: `${peak.tth.toFixed(3)}° (d=${dSpacing.toFixed(4)} Å)` };
        });
        
        const calcHklData = [];
        masterHklList.forEach(hkl => {
            calcHklData.push({ x: hkl.tth + params.zeroShift, tooltip: `${hkl.hkl_list[0]}` });
        });

        repositionMarkers(expPeakData, calcHklData);
        mainChart.update('none');
    }

    function repositionMarkers(expPeaksData, calcHklData) {
        if (!mainChart || !mainChart.scales.y) return;
        const y_scale = mainChart.scales.y;
        const findDataset = (label) => mainChart.data.datasets.find(d => d.label === label);
        
        const visibleYRange = y_scale.max - y_scale.min;
        const markerHeight = visibleYRange * 0.05; // 5% of the visible Y range

        // Position the experimental markers at the absolute bottom of the chart
        const expMarkerBottom = y_scale.min;
        const expMarkerTop = y_scale.min + markerHeight;
        const expMarkerY = [expMarkerBottom, expMarkerTop];

        // Position the calculated markers directly on top of the experimental ones
        const calcMarkerBottom = expMarkerTop;
        const calcMarkerTop = calcMarkerBottom + markerHeight;
        const calcMarkerY = [calcMarkerBottom, calcMarkerTop];

        findDataset('Experimental Peaks').data = expPeaksData.map(p => ({ ...p, y: expMarkerY }));
        findDataset('Calculated HKLs').data = calcHklData.map(p => ({ ...p, y: calcMarkerY }));
    }
    
    // --- Event Listeners ---

    controls.mainChartCanvas.addEventListener('contextmenu', e => {
    e.preventDefault();
    if (mainChart && fullExperimentalData.tth.length > 0) {
        // Manually reset the X-axis to the full data range
        mainChart.options.scales.x.min = fullExperimentalData.tth[0];
        mainChart.options.scales.x.max = fullExperimentalData.tth[fullExperimentalData.tth.length - 1];

        // Manually reset the Y-axis to its initial default proportions
        const yMax = mainChart.options.globalYMax;
        mainChart.options.scales.y.max = yMax * 1.1;
        mainChart.options.scales.y.min = -yMax * 0.3;

        // Redraw the markers and chart in the newly reset view
        repositionMarkersAndUpdate();
    }
});


    controls.mainChartCanvas.addEventListener('wheel', e => {
        e.preventDefault();
        const chart = mainChart;
        if (!chart || !chart.chartArea) return;
        const { left, right, top, bottom } = chart.chartArea;
        const zoomFactor = e.deltaY < 0 ? 0.9 : 1.1;

        const zoomOnAxis = (axisID, factor, focalPixel) => {
            const axis = chart.scales[axisID];
            if (!axis) return;
            const focalValue = axis.getValueForPixel(focalPixel);
            const newRange = (axis.max - axis.min) * factor;
            const focalRatio = (focalValue - axis.min) / (axis.max - axis.min);
            chart.options.scales[axisID].min = focalValue - newRange * focalRatio;
            chart.options.scales[axisID].max = focalValue + newRange * (1 - focalRatio);
        };

        if (e.offsetY > bottom) zoomOnAxis('x', zoomFactor, e.offsetX);
        else if (e.offsetX < left) zoomOnAxis('y', zoomFactor, e.offsetY);
        else { zoomOnAxis('x', zoomFactor, e.offsetX); zoomOnAxis('y', zoomFactor, e.offsetY); }
    
        chart.update('none');
        repositionMarkersAndUpdate();
    });

    controls.fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            try {
                const parsedData = detectAndParseFile(file.name, evt.target.result);
                if (!parsedData || parsedData.tth.length === 0) throw new Error("No valid data points parsed.");
                if (parsedData.wavelength) controls.wavelength.value = parsedData.wavelength.toFixed(5);
                
                fullExperimentalData.tth = parsedData.tth;
                fullExperimentalData.intensity = parsedData.intensity;
                fullExperimentalData.intensity_sqrt = parsedData.intensity.map(y => Math.sqrt(Math.max(0, y)));
                
                controls.fileName.textContent = file.name;
                controls.placeholder.style.display = 'none';
                controls.resultsContainer.style.display = 'flex';
                controls.saveReportButton.disabled = false;
                controls.saveReportButton.className = 'btn btn-primary';

                initializeChart();
                generateMasterHklList();
            } catch (error) {
                alert(`Error reading file: ${error.message}`);
                console.error(error);
            }
        };
        reader.readAsText(file);
    });

    const hklDependentControls = [controls.spaceGroupSelect, controls.wavelength, controls.zeroShift, controls.wavelength2, controls.ratio21];
    hklDependentControls.forEach(control => control.addEventListener('input', () => {
        if (fullExperimentalData.tth.length > 0) generateMasterHklList();
    }));
    controls.latticeParamsContainer.addEventListener('input', () => {
        if (fullExperimentalData.tth.length > 0) generateMasterHklList();
    });
    
    const chartUpdateOnlyControls = [controls.rollingBallWindow, controls.peakThreshold];
    chartUpdateOnlyControls.forEach(control => control.addEventListener('input', () => {
        if (fullExperimentalData.tth.length > 0) updateChartWithNewData();
    }));
    
    controls.rollingBallWindow.addEventListener('input', (e) => { controls.rollingBallWindowValue.textContent = `${e.target.value} pts`; });
    controls.peakThreshold.addEventListener('input', (e) => { controls.peakThresholdValue.textContent = `${parseFloat(e.target.value).toFixed(1)} %`; });


    controls.bravaisLattice.addEventListener('change', updateUIForSystemChange);

    document.querySelector('.tab-buttons').addEventListener('click', (e) => {
        const clickedTab = e.target.closest('.tab-btn');
        if (clickedTab) {
            e.currentTarget.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            clickedTab.classList.add('active');
            document.querySelectorAll('.tab-content-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(`tab-panel-${clickedTab.dataset.tab}`).classList.add('active');
        }
    });

    const tooltipContainer = document.querySelector('.help-tooltip-container');
    const tooltipContent = document.querySelector('.tooltip-content');
    if (tooltipContainer && tooltipContent) {
        let tooltipTimer;
        tooltipContainer.addEventListener('mouseenter', () => {
            clearTimeout(tooltipTimer);
            tooltipContent.classList.add('visible');
        });
        tooltipContainer.addEventListener('mouseleave', () => {
            tooltipTimer = setTimeout(() => {
                tooltipContent.classList.remove('visible');
            }, 300);
        });
    }

    const resizer = document.getElementById('drag-handle');
    const leftPanel = document.getElementById('controls-panel');
    resizer.addEventListener('mousedown', (e) => {
        e.preventDefault(); document.body.style.cursor = 'col-resize';
        const moveHandler = (moveEvent) => { if (moveEvent.clientX > 350 && moveEvent.clientX < window.innerWidth - 350) leftPanel.style.width = `${moveEvent.clientX}px`; };
        const upHandler = () => { document.body.style.cursor = 'default'; window.removeEventListener('mousemove', moveHandler); window.removeEventListener('mouseup', upHandler); };
        window.addEventListener('mousemove', moveHandler); window.addEventListener('mouseup', upHandler);
    });
    
    controls.saveReportButton.addEventListener('click', () => {
        const reportContent = generateReportContent();
        downloadTextFile(reportContent, `Indexing-Report-${new Date().toISOString().slice(0, 10)}.txt`);
    });

    // Report Generation
    function generateReportContent() {
        const now = new Date();
        const params = getAllParams();
        const selectedSg = spaceGroups.find(sg => sg.number === parseInt(controls.spaceGroupSelect.value, 10));
        const spaceGroupName = selectedSg ? `${selectedSg.number} – ${selectedSg.name}` : 'N/A';
        const header = ['Indexman Report', '==================================================', `Report Generated: ${now.toLocaleString()}`, `Data File: ${controls.fileName.textContent}`, ''];
        const paramSection = ['--- Current Parameters ---', `System:        ${controls.bravaisLattice.options[controls.bravaisLattice.selectedIndex].text}`, `Space Group:   ${spaceGroupName}`, `a (Å):         ${params.a?.toFixed(5) || '-'}`, `b (Å):         ${params.b?.toFixed(5) || '-'}`, `c (Å):         ${params.c?.toFixed(5) || '-'}`, `beta (°):      ${params.beta?.toFixed(3) || '-'}`, `Radiation 1 (Å): ${params.lambda.toFixed(5)}`, `Radiation 2 (Å): ${params.lambda2.toFixed(5)}`, `Ratio (I₂/I₁):   ${params.ratio.toFixed(3)}`, `Zero Shift (°):  ${params.zeroShift.toFixed(4)}`, ''];
        const peaks = findExperimentalPeaks(fullExperimentalData.tth, fullExperimentalData.intensity, fullExperimentalData.intensity_sqrt, parseFloat(controls.peakThreshold.value), 5);
        const peakSection = ['--- Found Experimental Peaks ---', '2theta (°)      d (Å)           Intensity'];
        peaks.forEach(p => {
            const dSpacing = params.lambda / (2 * Math.sin(p.tth * Math.PI / 360));
            peakSection.push(`${p.tth.toFixed(4).padEnd(16)} ${dSpacing.toFixed(5).padEnd(16)} ${p.intensity.toFixed(1)}`);
        });
        const hklSection = ['', '--- Calculated HKL Positions ---', '2theta_calc (°)  h,k,l'];
        masterHklList.forEach(hkl => hklSection.push(`${(hkl.tth + params.zeroShift).toFixed(4).padEnd(16)} ${hkl.hkl_list[0]}`));
        return [...header, ...paramSection, ...peakSection, ...hklSection].join('\n');
    }
    function downloadTextFile(content, filename) {
        const element = document.createElement('a');
        const file = new Blob([content], {type: 'text/plain;charset=utf-8'});
        element.href = URL.createObjectURL(file);
        element.download = filename;
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }

    // Initialize UI
    updateUIForSystemChange();
});
</script>

</body>
</html>